<script>
  const API_URL = 'https://script.google.com/macros/s/โป้วางลิงก์ Web App/exec';

  async function fetchSheetFromScript() {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error('โหลดข้อมูลล้มเหลว');
    const allSheets = await res.json(); // ต้องให้ Apps Script คืนเป็น { MakroLog: [...], IncomeLog: [...] }
    return allSheets;
  }

  function parseCurrency(val) {
    if (!val) return 0;
    const cleaned = val.toString().replace(/[^0-9.-]+/g, '');
    return parseFloat(cleaned) || 0;
  }

  function calculateMonthlyTotals(rows, columnIndex) {
    const now = new Date();
    const currentMonth = now.toISOString().slice(0, 7);
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().slice(0, 7);
    let thisMonth = 0, prevMonth = 0;
    rows.forEach(r => {
      const date = r[0];
      const val = parseCurrency(r[columnIndex]);
      if (!date || isNaN(val)) return;
      const month = new Date(date).toISOString().slice(0, 7);
      if (month === currentMonth) thisMonth += val;
      else if (month === lastMonth) prevMonth += val;
    });
    return [thisMonth, prevMonth];
  }

  async function updateDashboard() {
    try {
      const data = await fetchSheetFromScript();

      // รายรับ: IncomeLog!A:B (วันที่, ยอดขาย)
      const incomeData = data.IncomeLog.slice(1).map(r => [r[0], r[1]]);
      const [incomeThis, incomeLast] = calculateMonthlyTotals(incomeData, 1);
      document.getElementById('incomeCurrentMonth').textContent = `เดือนนี้: ${incomeThis.toFixed(2)} บาท`;
      document.getElementById('incomeLastMonth').textContent = `เดือนก่อน: ${incomeLast.toFixed(2)} บาท`;

      // รายจ่าย: MakroLog!A:G (วันที่, ราคารวม)
      const expenseData = data.MakroLog.slice(1).map(r => [r[0], r[6]]);
      const [expenseThis, expenseLast] = calculateMonthlyTotals(expenseData, 1);
      document.getElementById('expenseCurrentMonth').textContent = `เดือนนี้: ${expenseThis.toFixed(2)} บาท`;
      document.getElementById('expenseLastMonth').textContent = `เดือนก่อน: ${expenseLast.toFixed(2)} บาท`;

    } catch (err) {
      alert('❌ เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + err.message);
    }
  }

  updateDashboard();
</script>
