<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>บันทึกบิล/รายจ่าย</title>
  <style>
    /* CSS เดิม เหมือนใน Canvas */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <h1>บันทึกบิล/รายจ่าย</h1>
    <form id="billForm" novalidate>
      <!-- form-row, items-container, btn-row เหมือนเดิม -->
    </form>
  </div>

  <datalist id="namelist"></datalist>
  <!-- grouplist, supplierlist เหมือนเดิม -->

  <template id="item-template">
    <!-- item template เหมือนเดิม -->
  </template>

  <script>
    const apiURL = 'https://script.google.com/macros/s/.../exec'; // แก้เป็น URL จริง

    let productList = [];
    const state = { total: 0, saved: 0 };

    // โหลด marketlist ด้วย JSONP
    function loadProductData() {
      const script = document.createElement('script');
      script.src = `${apiURL}?sheet=marketlist&callback=handleProductDataResponse`;
      document.body.appendChild(script);
    }
    function handleProductDataResponse(data) {
      productList = data;
      const datalist = document.getElementById('namelist');
      datalist.innerHTML = '';
      data.forEach(item => {
        if (item.name) {
          const opt = document.createElement('option');
          opt.value = item.name;
          datalist.appendChild(opt);
        }
      });
      addItemRow();
    }

    // ฟังก์ชัน addItemRow, updateItemIndices, event listeners (เหมือนเดิม) for form-row & remove button & calculate total

    // เปลี่ยนมาส่งข้อมูลด้วย POST
    document.getElementById('billForm').addEventListener('submit', async e => {
      e.preventDefault();
      if (!e.target.checkValidity()) { e.target.reportValidity(); return; }
      const date = document.getElementById('date_bill').value;
      const supplier = document.getElementById('supplier').value;
      const items = Array.from(document.querySelectorAll('#items-container .item')).map(item => ({
        nm: item.querySelector('.name').value,
        gr: item.querySelector('.group').value,
        am: item.querySelector('.amount').value,
        un: item.querySelector('.unit').value,
        pu: item.querySelector('.price_unit').value,
        to: item.querySelector('.total').value,
        in_unit: item.querySelector('.in_unit').value,
        sec_unit: item.querySelector('.sec_unit').value,
        note: item.querySelector('.note').value
      })).filter(it => parseFloat(it.am) > 0);
      if (items.length === 0) {
        Swal.fire('ไม่มีรายการ', 'กรอกสินค้าอย่างน้อยหนึ่งรายการ', 'warning'); return;
      }

      // ยืนยันด้วย SweetAlert
      const totalAll = items.reduce((s,it) => s + parseFloat(it.to), 0).toFixed(2);
      const html = `...`; // สร้าง HTML ใบเสร็จเหมือนเดิม
      const { isConfirmed } = await Swal.fire({ title: 'ตรวจสอบข้อมูล', html, showCancelButton: true, confirmButtonText: 'ยืนยัน' });
      if (!isConfirmed) return;

      // POST JSON
      try {
        const res = await fetch(apiURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sheet: 'datalog', date_bill: date, supplier, items })
        });
        const json = await res.json();
        if (json.success) {
          Swal.fire('บันทึกสำเร็จ', '', 'success');
          document.getElementById('billForm').reset();
          document.getElementById('items-container').innerHTML = '';
          document.getElementById('date_bill').valueAsDate = new Date();
          addItemRow();
        } else {
          Swal.fire('ผิดพลาด', json.message, 'error');
        }
      } catch (err) {
        Swal.fire('เชื่อมต่อไม่สำเร็จ', '', 'error');
        console.error(err);
      }
    });

    // เริ่มทำงาน
    document.getElementById('date_bill').valueAsDate = new Date();
    loadProductData();
  </script>
</body>
</html>

// Code.gs ยังคงเหมือนเดิม doPost + doGet รองรับ JSONP
