<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Form</title>
  <style>
    /* ตัวอย่างสไตล์ใบเสร็จ */
    #preview {
      border: 1px dashed #333;
      padding: 16px;
      margin-top: 20px;
      max-width: 400px;
      font-family: "Sarabun", sans-serif;
    }
    #preview h3 { text-align: center; margin-bottom: 12px; }
    #preview p { margin: 4px 0; }
    #preview button { margin-top: 12px; }
  </style>
</head>
<body>
  <h2>ฟอร์มบันทึกรายจ่าย</h2>
  <form id="expenseForm">
    <label>วันที่ซื้อ: <input type="date" id="date" required></label><br>
    <label>แหล่งที่ซื้อ:
      <input list="sourceSuggestions" id="source" oninput="onSourceInput()" required>
      <datalist id="sourceSuggestions"></datalist>
    </label><br>
    <label>รายการที่ซื้อ:
      <input list="itemSuggestions" id="item" oninput="onItemInput()" required>
      <datalist id="itemSuggestions"></datalist>
    </label><br>
    <label>หมวดหมู่: <input type="text" id="category" readonly></label><br>
    <label>จำนวน:
      <input type="number" id="quantity" step="0.01" required>
    </label>
    <label>หน่วย:
      <input list="unitSuggestions" id="unit" oninput="onUnitInput()" required>
      <datalist id="unitSuggestions"></datalist>
    </label><br>
    <label>ราคาต่อหน่วย: <input type="number" id="price" step="1" required></label><br>
    <label>หมายเหตุ: <input type="text" id="note"></label><br>
    <button type="submit">บันทึกข้อมูล</button>
  </form>

  <!-- พรีวิวก่อนบันทึก -->
  <div id="preview" style="display:none;">
    <h3>ตัวอย่างใบเสร็จ</h3>
    <p><strong>วันที่:</strong> <span id="pv-date"></span></p>
    <p><strong>แหล่งที่ซื้อ:</strong> <span id="pv-source"></span></p>
    <p><strong>รายการ:</strong> <span id="pv-item"></span> (<span id="pv-category"></span>)</p>
    <p><strong>จำนวน:</strong> <span id="pv-quantity"></span> <span id="pv-unit"></span></p>
    <p><strong>ราคารวม:</strong> <span id="pv-total"></span> บาท</p>
    <p><strong>หมายเหตุ:</strong> <span id="pv-note"></span></p>
    <button id="confirmBtn">ยืนยันการบันทึก</button>
    <button id="cancelBtn">แก้ไข</button>
  </div>

  <script>
    const marketListURL = 'https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec?sheet=marketlist';
    let marketList = [];

    document.addEventListener('DOMContentLoaded', () => {
      // โหลด MarketList จาก Google Sheets
      fetch(marketListURL)
        .then(res => res.json())
        .then(data => {
          marketList = data.map(d => ({
            item: d.item.trim().toLowerCase(),
            display: d.item.trim(),
            category: d.category.trim()
          }));
          const dl = document.getElementById('itemSuggestions');
          marketList.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.display;
            dl.appendChild(opt);
          });
        });

      // โหลด history สำหรับแหล่งที่ซื้อ และ หน่วย
      const sourceHist = JSON.parse(localStorage.getItem('sourceHistory') || '[]');
      const unitHist = JSON.parse(localStorage.getItem('unitHistory') || '[]');
      const srcDL = document.getElementById('sourceSuggestions');
      const unitDL = document.getElementById('unitSuggestions');
      sourceHist.forEach(s => { let o = document.createElement('option'); o.value=s; srcDL.appendChild(o); });
      unitHist.forEach(u => { let o = document.createElement('option'); o.value=u; unitDL.appendChild(o); });

      // ฟอร์ม submit → พรีวิว
      document.getElementById('expenseForm').addEventListener('submit', e => {
        e.preventDefault();
        showPreview();
      });

      // ปุ่มยืนยัน / ยกเลิก
      document.getElementById('confirmBtn').addEventListener('click', saveData);
      document.getElementById('cancelBtn').addEventListener('click', () => {
        document.getElementById('preview').style.display = 'none';
      });
    });

    function onItemInput() {
      const val = document.getElementById('item').value.trim().toLowerCase();
      const found = marketList.find(d => d.item === val);
      if (found) {
        document.getElementById('category').value = found.category;
      } else {
        document.getElementById('category').value = '';
      }
    }

    function onSourceInput() {
      const val = document.getElementById('source').value.trim();
      if (!val) return;
      let arr = JSON.parse(localStorage.getItem('sourceHistory') || '[]');
      if (!arr.includes(val)) {
        arr.push(val);
        localStorage.setItem('sourceHistory', JSON.stringify(arr));
        let o = document.createElement('option'); o.value=val;
        document.getElementById('sourceSuggestions').appendChild(o);
      }
    }

    function onUnitInput() {
      const val = document.getElementById('unit').value.trim();
      if (!val) return;
      let arr = JSON.parse(localStorage.getItem('unitHistory') || '[]');
      if (!arr.includes(val)) {
        arr.push(val);
        localStorage.setItem('unitHistory', JSON.stringify(arr));
        let o = document.createElement('option'); o.value=val;
        document.getElementById('unitSuggestions').appendChild(o);
      }
    }

    function showPreview() {
      const d = document.getElementById('date').value;
      const s = document.getElementById('source').value;
      const i = document.getElementById('item').value;
      const c = document.getElementById('category').value;
      const q = parseFloat(document.getElementById('quantity').value);
      const u = document.getElementById('unit').value;
      const p = parseFloat(document.getElementById('price').value);
      const n = document.getElementById('note').value;
      document.getElementById('pv-date').textContent = d;
      document.getElementById('pv-source').textContent = s;
      document.getElementById('pv-item').textContent = i;
      document.getElementById('pv-category').textContent = c;
      document.getElementById('pv-quantity').textContent = q;
      document.getElementById('pv-unit').textContent = u;
      document.getElementById('pv-total').textContent = (q * p).toFixed(2);
      document.getElementById('pv-note').textContent = n;
      document.getElementById('preview').style.display = 'block';
    }

    function saveData() {
      const formData = new URLSearchParams();
      formData.append('date', document.getElementById('date').value);
      formData.append('source', document.getElementById('source').value.trim().toLowerCase());
      formData.append('item', document.getElementById('item').value.trim().toLowerCase());
      formData.append('category', document.getElementById('category').value);
      formData.append('quantity', document.getElementById('quantity').value);
      formData.append('unit', document.getElementById('unit').value.trim().toLowerCase());
      formData.append('price', document.getElementById('price').value);
      formData.append('note', document.getElementById('note').value);
      // บันทึกลง Google Apps Script
      fetch('https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec', {
        method: 'POST',
        body: formData
      })
      .then(r => r.text())
      .then(text => {
        alert('บันทึกเรียบร้อย!');
        location.reload();
      });
    }

    // ฟังก์ชันลบข้อมูล (ใช้ row index)
    function deleteRow(rowIdx) {
      const params = new URLSearchParams({ action: 'delete', row: rowIdx });
      fetch('https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec', {
        method: 'POST',
        body: params
      }).then(() => alert('ลบเรียบร้อย')).then(() => location.reload());
    }

    // ฟังก์ชันแก้ไขข้อมูล (update)
    function updateData(rowIdx, newData) {
      const params = new URLSearchParams({ action: 'update', row: rowIdx, ...newData });
      fetch('https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec', {
        method: 'POST',
        body: params
      }).then(() => alert('อัปเดตเรียบร้อย')).then(() => location.reload());
    }
  </script>
</body>
</html>
