<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏• / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #5fa0ff; font-family: 'Noto Sans', sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px; }
    .container { background: #fff; border: 3px solid #c2e7ff; border-radius: 24px; width: 100%; max-width: 420px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1 { font-size: 20px; text-align: center; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 4px solid #c2e7ff; }
    .form-row { display: flex; gap: 12px; margin-bottom: 16px; }
    .form-group { flex: 1; display: flex; flex-direction: column; }
    .form-group label { margin-bottom: 4px; font-weight: 500; }
    .form-group input { width: 100%; padding: 10px; font-size: 14px; height: 40px; border: 1px solid #ccc; border-radius: 8px; }
    .items { margin-top: 16px; }
    .item { background: #e0f7ff; border-radius: 16px; padding: 12px; margin-bottom: 16px; position: relative; }
    .item h2 { font-size: 16px; font-weight: bold; margin-bottom: 12px; }
    .item-grid { display: grid; gap: 8px; margin-bottom: 12px; }
    .item-grid.header { grid-template-columns: 3fr 2fr; }
    .item-grid.main { grid-template-columns: repeat(4, 1fr); }
    .item-grid.secondary { grid-template-columns: repeat(3, 1fr); }
    .item-grid input { width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
    .remove { position: absolute; top: 12px; right: 12px; background: #ef4444; color: #fff; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; }
    .btn-row { display: flex; gap: 12px; margin-top: 16px; }
    button#add-item, button#submit { flex: 1; padding: 12px; font-size: 15px; border: none; border-radius: 8px; cursor: pointer; }
    button#add-item { background: #ffdb4d; color: #111827; }
    button#submit { background: #4d83ff; color: #fff; }
    .menu-links { display: flex; gap: 12px; margin-top: 24px; }
    .btn-nav { flex: 1; padding: 12px; font-size: 15px; font-weight: bold; text-align: center; color: #fff; border-radius: 8px; text-decoration: none; }
    .btn-blue { background: #3b82f6; } .btn-green { background: #10b981; } .btn-purple { background: #8b3ced; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
    <form id="billForm" novalidate>
      <div class="form-row">
        <div class="form-group">
          <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
          <input type="date" id="date_bill" required />
        </div>
        <div class="form-group">
          <label>üè™ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
          <input type="text" id="supplier" list="supplierlist" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠" required />
        </div>
      </div>
      <div class="items" id="items-container"></div>
      <div class="btn-row">
        <button type="button" id="add-item">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
        <button type="submit" id="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    </form>
    <nav class="menu-links">
      <a href="index.html" class="btn-nav btn-blue">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
      <a href="income.html" class="btn-nav btn-green">üíµ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</a>
      <a href="dashboard.html" class="btn-nav btn-purple">üìä Dashboard</a>
    </nav>
  </div>

  <datalist id="namelist"></datalist>
  <datalist id="supplierlist">
    <option value="Makro"><option value="7-eleven"><option value="Tops"><option value="Lotus"><option value="Lazada"><option value="Shopee">
  </datalist>

  <template id="item-template">
    <div class="item">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà <span class="item-index">1</span></h2>
      <div class="item-grid header">
        <input type="text" class="name" list="namelist" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" />
        <input type="text" class="group" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" readonly />
      </div>
      <div class="item-grid main">
        <input type="number" class="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required inputmode="numeric" pattern="[0-9]*" />
        <input type="text" class="unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" readonly />
        <input type="number" class="price_unit" step="0.01" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢" required inputmode="decimal" />
        <input type="text" class="total" readonly placeholder="‡∏£‡∏ß‡∏°" />
      </div>
      <div class="item-grid secondary">
        <input type="text" class="in_unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏¢" readonly />
        <input type="text" class="sec_unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á" readonly />
        <input type="text" class="note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" />
      </div>
      <button type="button" class="remove">‡∏•‡∏ö</button>
    </div>
  </template>

  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbzez-fh075oK0A8-JxKz2sozwPLj2uF9jrpPLA_Mq0707SVhi2pp_FIa0NOfYe8EM8aYA/exec';
    const state = { total: 0, saved: 0 };
    let productList;

    function loadData() {
      const tag = document.createElement('script');
      tag.src = `${apiURL}?sheet=marketlist&callback=handleData`;
      document.body.appendChild(tag);
    }

    function handleData(data) {
      productList = data;
      const dl = document.getElementById('namelist');
      dl.innerHTML = '';
      data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.name;
        dl.appendChild(opt);
      });
      addItemRow();
    }

    function addItemRow() {
      const cont = document.getElementById('items-container');
      const clone = document.getElementById('item-template').content.cloneNode(true);
      const nameInput = clone.querySelector('.name');
      nameInput.addEventListener('change', () => {
        const sel = productList.find(p => p.name === nameInput.value);
        if (sel) {
          const row = nameInput.closest('.item');
          row.querySelector('.group').value = sel.group || '';
          row.querySelector('.unit').value = sel.unit || '';
          row.querySelector('.in_unit').value = sel.in_unit || '';
          row.querySelector('.sec_unit').value = sel.sec_unit || '';
        }
      });
      clone.querySelector('.remove').onclick = e => { e.target.closest('.item').remove(); updateIndices(); };
      cont.appendChild(clone);
      updateIndices();
    }

    function updateIndices() {
      document.querySelectorAll('.item').forEach((el, idx) => {
        el.querySelector('.item-index').textContent = idx + 1;
      });
    }

    document.getElementById('items-container').addEventListener('input', e => {
      if (e.target.matches('.amount, .price_unit')) {
        const row = e.target.closest('.item');
        const a = parseFloat(row.querySelector('.amount').value) || 0;
        const p = parseFloat(row.querySelector('.price_unit').value) || 0;
        row.querySelector('.total').value = (a * p).toFixed(2);
      }
    });

    document.getElementById('add-item').onclick = addItemRow;
    document.getElementById('billForm').onsubmit = e => {
      e.preventDefault();
      if (!e.target.checkValidity()) { e.target.reportValidity(); return; }
      const date = document.getElementById('date_bill').value;
      const sup = document.getElementById('supplier').value;
      const items = [];
      document.querySelectorAll('.item').forEach(r => {
        if (!r.querySelector('.amount').value) return;
        items.push({
          nm: r.querySelector('.name').value,
          gr: r.querySelector('.group').value,
          am: r.querySelector('.amount').value,
          un: r.querySelector('.unit').value,
          pu: r.querySelector('.price_unit').value,
          to: r.querySelector('.total').value,
          in_unit: r.querySelector('.in_unit').value,
          sec_unit: r.querySelector('.sec_unit').value,
          note: r.querySelector('.note').value
        });
      });
      if (!items.length) { Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','warning'); return; }
      let html = `<div style="text-align:left;font-size:13px;">üßæ<strong>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß</strong><br>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${date}<br>‡∏£‡πâ‡∏≤‡∏ô: ${sup}<hr>`;
      html += items.map(it => `<strong>${it.nm}</strong><br>${it.am} ${it.un} x ${it.pu} = ${it.to} ‡∏ö‡∏≤‡∏ó`).join('<br>');
      html += `<hr><em>‡∏£‡∏ß‡∏° ${items.reduce((sum, x) => sum + parseFloat(x.to),0).toFixed(2)} ‡∏ö‡∏≤‡∏ó</em></div>`;
      Swal.fire({ title: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', html, showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' })
        .then(res => {
          if (res.isConfirmed) {
            state.total = items.length;
            state.saved = 0;
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            items.forEach(it => {
              const qs = `?sheet=datalog&date_bill=${encodeURIComponent(date)}` +
                         `&supplier=${encodeURIComponent(sup)}` +
                         `&name=${encodeURIComponent(it.nm)}` +
                         `&unit=${encodeURIComponent(it.un)}` +
                         `&group=${encodeURIComponent(it.gr)}` +
                         `&amount=${encodeURIComponent(it.am)}` +
                         `&price_unit=${encodeURIComponent(it.pu)}` +
                         `&total=${encodeURIComponent(it.to)}` +
                         `&in_unit=${encodeURIComponent(it.in_unit)}` +
                         `&sec_unit=${encodeURIComponent(it.sec_unit)}` +
                         `&note=${encodeURIComponent(it.note)}` +
                         `&callback=handleSubmit`;
              const scriptTag = document.createElement('script');
              scriptTag.src = apiURL + qs;
              document.body.appendChild(scriptTag);
            });
          }
        });
    };

    function handleSubmit(msg) {
      state.saved++;
      if (state.saved >= state.total) {
        Swal.close();
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','success').then(() => {
          document.getElementById('billForm').reset();
          document.getElementById('items-container').innerHTML = '';
          addItemRow();
        });
      }
    }

    loadData();
  </script>
</body>
</html>
