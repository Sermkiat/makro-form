<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏• / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #5fa0ff; font-family: 'Noto Sans', sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px; }
    .container { background: #fff; border: 3px solid #c2e7ff; border-radius: 24px; width: 100%; max-width: 420px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1 { font-size: 20px; text-align: center; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 4px solid #c2e7ff; }
    .form-row { display: flex; gap: 12px; margin-bottom: 16px; }
    .form-group { flex: 1; display: flex; flex-direction: column; }
    .form-group label { margin-bottom: 4px; font-weight: 500; }
    .form-group input { width: 100%; padding: 10px; font-size: 14px; height: 40px; border: 1px solid #ccc; border-radius: 8px; }
    .items { margin-top: 16px; }
    .item { background: #e0f7ff; border-radius: 16px; padding: 12px; margin-bottom: 16px; position: relative; }
    .item h2 { font-size: 16px; font-weight: bold; margin-bottom: 12px; }
    .item-grid { display: grid; gap: 8px; margin-bottom: 12px; }
    .item-grid.header { grid-template-columns: 3fr 2fr; }
    .item-grid.main { grid-template-columns: repeat(4, 1fr); }
    .item-grid.secondary { grid-template-columns: repeat(3, 1fr); }
    .item-grid input { width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
    .remove { position: absolute; top: 12px; right: 12px; background: #ef4444; color: #fff; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; }
    .btn-row { display: flex; gap: 12px; margin-top: 16px; }
    button#add-item, button#submit { flex: 1; padding: 12px; font-size: 15px; border: none; border-radius: 8px; cursor: pointer; }
    button#add-item { background: #ffdb4d; color: #111827; }
    button#submit { background: #4d83ff; color: #fff; }
    .menu-links { display: flex; gap: 12px; margin-top: 24px; }
    .btn-nav { flex: 1; padding: 12px; font-size: 15px; font-weight: bold; text-align: center; color: #fff; border-radius: 8px; text-decoration: none; }
    .btn-blue { background: #3b82f6; }
    .btn-green { background: #10b981; }
    .btn-purple { background: #8b3ced; }
    .item .error { color: #ef4444; font-size: 12px; margin-top: 2px; }
    .form-error { color: #ef4444; font-size: 14px; text-align: center; margin-bottom: 8px; }
    @media (max-width: 480px) {
      .container { width: 96vw; padding: 12px 4vw;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
    <form id="billForm" novalidate>
      <div class="form-row">
        <div class="form-group">
          <label for="date_bill">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
          <input type="date" id="date_bill" required />
        </div>
        <div class="form-group">
          <label for="supplier">üè™ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
          <input type="text" id="supplier" list="supplierlist" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠" required />
        </div>
      </div>
      <div id="form-error" class="form-error" style="display:none"></div>
      <div class="items" id="items-container"></div>
      <div class="btn-row">
        <button type="button" id="add-item">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
        <button type="submit" id="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    </form>
    <nav class="menu-links">
      <a href="index.html" class="btn-nav btn-blue">üè† Home</a>
      <a href="income.html" class="btn-nav btn-green">üíµ Good Income</a>
      <a href="dashboard.html" class="btn-nav btn-purple">üìä Dashboard</a>
    </nav>
  </div>

  <datalist id="namelist"></datalist>
  <datalist id="grouplist">
    <option value="‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß"></option>
    <option value="‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏°"></option>
    <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô"></option>
    <option value="‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô/‡πÉ‡∏ä‡πâ‡∏û‡∏£‡∏≤‡∏ß"></option>
    <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß"></option>
    <option value="‡∏¢‡∏≤"></option>
    <option value="‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß/‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô"></option>
    <option value="‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°"></option>
    <option value="‡∏á‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á"></option>
  </datalist>
  <datalist id="supplierlist">
    <option value="Makro"></option>
    <option value="7-eleven"></option>
    <option value="Tops"></option>
    <option value="Lotus"></option>
    <option value="Lazada"></option>
    <option value="Shopee"></option>
  </datalist>

  <template id="item-template">
    <div class="item">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà <span class="item-index">1</span></h2>
      <div class="item-grid header">
        <div>
          <input type="text" class="name" list="namelist" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required autocomplete="off" />
          <div class="error name-error" style="display:none"></div>
        </div>
        <div>
          <input type="text" class="group" list="grouplist" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required autocomplete="off" />
          <div class="error group-error" style="display:none"></div>
        </div>
      </div>
      <div class="item-grid main">
        <div>
          <input type="number" min="0" class="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required inputmode="numeric" />
          <div class="error amount-error" style="display:none"></div>
        </div>
        <div>
          <input type="text" class="unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" autocomplete="off" />
        </div>
        <div>
          <input type="number" step="0.01" min="0" class="price_unit" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢" required inputmode="decimal" />
        </div>
        <div>
          <input type="text" class="total" readonly placeholder="‡∏£‡∏ß‡∏°" />
        </div>
      </div>
      <div class="item-grid secondary">
        <div>
          <input type="number" min="0" class="in_unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏¢" />
        </div>
        <div>
          <input type="text" class="sec_unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢" />
        </div>
        <div>
          <input type="text" class="note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" />
        </div>
      </div>
      <button type="button" class="remove">‡∏•‡∏ö</button>
    </div>
  </template>

  <script>
    // URL API ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwe8OxIf7vAzkjuco79GN0rcQsZMLWnCId-3rdMQtFcLH92ab92TsF5TeZF78b0aUcLKA/exec';
    let productList = [];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete
    function loadProductData() {
      fetch(WEB_APP_URL + '?action=marketlist')
        .then(r => r.json())
        .then(list => {
          productList = list;
          const dl = document.getElementById('namelist');
          dl.innerHTML = list.map(p => `<option value="${p.nm}"></option>`).join('');
        })
        .catch(() => {
          Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
        });
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
    function addItemRow(values = {}) {
      const container = document.getElementById('items-container');
      const tpl = document.getElementById('item-template').content.cloneNode(true);
      const row = tpl.querySelector('.item');

      // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      row.querySelector('.name').value = values.nm || '';
      row.querySelector('.group').value = values.gr || '';
      row.querySelector('.amount').value = values.am || '';
      row.querySelector('.unit').value = values.un || '';
      row.querySelector('.price_unit').value = values.pu || '';
      row.querySelector('.total').value = values.to || '';
      row.querySelector('.in_unit').value = values.in_unit || '';
      row.querySelector('.sec_unit').value = values.sec_unit || '';
      row.querySelector('.note').value = values.note || '';

      // autocomplete ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      row.querySelector('.name').addEventListener('change', e => {
        const sel = productList.find(p => p.nm === e.target.value);
        if (sel) {
          const parent = e.target.closest('.item');
          parent.querySelector('.group').value = sel.gr || '';
          parent.querySelector('.unit').value = sel.un || '';
          parent.querySelector('.in_unit').value = sel.in_unit || '';
          parent.querySelector('.sec_unit').value = sel.sec_unit || '';
          parent.querySelector('.amount').focus();
        }
      });

      // remove button
      row.querySelector('.remove').onclick = () => { 
        row.remove(); 
        updateItemIndices(); 
      };

      container.appendChild(row);
      updateItemIndices();
      row.querySelector('.name').focus();
    }

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    function updateItemIndices() {
      document.querySelectorAll('#items-container .item').forEach((el, i) => {
        el.querySelector('.item-index').textContent = i+1;
      });
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total
    document.getElementById('items-container').addEventListener('input', e => {
      if (e.target.matches('.amount, .price_unit')) {
        const row = e.target.closest('.item');
        const am = parseFloat(row.querySelector('.amount').value) || 0;
        const pu = parseFloat(row.querySelector('.price_unit').value) || 0;
        row.querySelector('.total').value = (am * pu).toFixed(2);
      }
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
    document.getElementById('add-item').onclick = () => addItemRow();

    // validate ‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    function validateItems() {
      let valid = true;
      document.querySelectorAll('#items-container .item').forEach(row => {
        const name = row.querySelector('.name');
        const group = row.querySelector('.group');
        const amount = row.querySelector('.amount');
        // ‡∏ã‡πà‡∏≠‡∏ô error ‡∏Å‡πà‡∏≠‡∏ô
        row.querySelector('.name-error').style.display = 'none';
        row.querySelector('.group-error').style.display = 'none';
        row.querySelector('.amount-error').style.display = 'none';

        if (!name.value.trim()) {
          row.querySelector('.name-error').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
          row.querySelector('.name-error').style.display = '';
          valid = false;
        }
        if (!group.value.trim()) {
          row.querySelector('.group-error').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
          row.querySelector('.group-error').style.display = '';
          valid = false;
        }
        if (!(parseFloat(amount.value) > 0)) {
          row.querySelector('.amount-error').textContent = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0';
          row.querySelector('.amount-error').style.display = '';
          valid = false;
        }
      });
      return valid;
    }

    // validate ‡∏ü‡∏≠‡∏£‡πå‡∏°
    function validateForm() {
      const date_bill = document.getElementById('date_bill').value;
      const supplier = document.getElementById('supplier').value.trim();
      let errorMsg = '';
      if (!date_bill) errorMsg = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠';
      else if (!supplier) errorMsg = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠';
      if (errorMsg) {
        document.getElementById('form-error').textContent = errorMsg;
        document.getElementById('form-error').style.display = '';
        return false;
      }
      document.getElementById('form-error').style.display = 'none';
      return true;
    }

    // ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById('billForm').addEventListener('submit', async e => {
      e.preventDefault();
      if (!validateForm() || !validateItems()) return;
      const dateBill = document.getElementById('date_bill').value;
      const supplier = document.getElementById('supplier').value;
      const items = Array.from(document.querySelectorAll('#items-container .item')).map(row => {
        const am = parseFloat(row.querySelector('.amount').value) || 0;
        return { 
          nm: row.querySelector('.name').value.trim(),
          gr: row.querySelector('.group').value.trim(),
          am: am,
          un: row.querySelector('.unit').value.trim(),
          pu: parseFloat(row.querySelector('.price_unit').value) || 0,
          to: parseFloat(row.querySelector('.total').value) || 0,
          in_unit: row.querySelector('.in_unit').value.trim(),
          sec_unit: row.querySelector('.sec_unit').value.trim(),
          note: row.querySelector('.note').value.trim()
        };
      }).filter(it => it.am>0 && it.nm && it.gr);
      if (items.length===0) { 
        Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','warning'); 
        return; 
      }
      // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      let html=`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateBill}<br>‡∏£‡πâ‡∏≤‡∏ô: ${supplier}<hr>`;
      items.forEach(it=> html+=`${it.nm}: ${it.am} x ${it.pu} = ${it.to}<br>`);
      html+=`<hr>‡∏£‡∏ß‡∏° ${(items.reduce((s,it)=>s+it.to,0)).toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
      const res = await Swal.fire({ title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', html, showCancelButton:true, confirmButtonText:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', cancelButtonText:'‡∏Å‡∏•‡∏±‡∏ö'});
      if (!res.isConfirmed) return;
      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      Swal.showLoading();
      fetch(WEB_APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ sheet:'datalog', date_bill:dateBill, supplier, items })
      })
      .then(r=>r.json())
      .then(r=>{
        Swal.close();
        if(r.success){
          Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success').then(()=>{
            document.getElementById('billForm').reset(); 
            document.getElementById('items-container').innerHTML=''; 
            document.getElementById('date_bill').valueAsDate=new Date(); 
            addItemRow();
          });
        }
        else Swal.fire('Error', r.message,'error');
      }).catch(()=> {
        Swal.close();
        Swal.fire('Error','‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠','error');
      });
    });

    // init
    document.getElementById('date_bill').valueAsDate = new Date();
    loadProductData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    addItemRow(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å

  </script>
</body>
</html>
