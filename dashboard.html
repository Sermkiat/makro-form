<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>р╣Бр╕Фр╕Кр╕Ър╕нр╕гр╣Мр╕Фр╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body class="bg-gray-100 font-sans p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">ЁЯУК р╣Бр╕Фр╕Кр╕Ър╕нр╕гр╣Мр╕Фр╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold">ЁЯТ░ р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф</h2>
        <p id="totalSpending" class="text-2xl text-green-600 mt-2">р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е...</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold">ЁЯУЕ р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ</h2>
        <ul id="dailySpending" class="text-sm mt-2"></ul>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold">ЁЯЧУя╕П р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ</h2>
        <ul id="monthlySpending" class="text-sm mt-2"></ul>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold">ЁЯУК р╕Бр╕гр╕▓р╕Яр╣Бр╕Чр╣Ир╕З: р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ</h2>
        <div id="barChart" style="width: 100%; height: 400px;"></div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold">ЁЯзБ р╕Бр╕гр╕▓р╕Яр╕зр╕Зр╕Бр╕ер╕б: р╕кр╕▒р╕Фр╕кр╣Ир╕зр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Лр╕╖р╣Йр╕н</h2>
        <div id="pieChart" style="width: 100%; height: 400px;"></div>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold">ЁЯПЖ р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕Лр╕╖р╣Йр╕нр╕Ър╣Ир╕нр╕в 5 р╕нр╕▒р╕Щр╕Фр╕▒р╕Ъ</h2>
      <ul id="topItems" class="list-decimal ml-5 mt-2 text-sm"></ul>
    </div>
  </div>

  <script>
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(drawDashboard);

    function drawDashboard() {
      const queryString = encodeURIComponent('SELECT A, C, F');
      const dataSourceUrl = 'https://docs.google.com/spreadsheets/d/1bniIL-y285kEHvF_bzRRBOUYGrwcjwEaIrxWGIwh71s/gviz/tq?sheet=MakroLog&tq=' + queryString;

      const query = new google.visualization.Query(dataSourceUrl);
      query.send(response => {
        if (response.isError()) {
          alert('р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф: ' + response.getMessage());
          return;
        }

        const data = response.getDataTable();
        let total = 0;
        const dailyMap = {};
        const monthlyMap = {};
        const itemMap = {};

        for (let i = 0; i < data.getNumberOfRows(); i++) {
          const date = data.getValue(i, 0);
          const item = data.getValue(i, 1);
          const totalPrice = parseFloat(data.getValue(i, 2));

          if (!date || !item || isNaN(totalPrice)) continue;

          total += totalPrice;
          dailyMap[date] = (dailyMap[date] || 0) + totalPrice;

          const month = date.slice(0, 7);
          monthlyMap[month] = (monthlyMap[month] || 0) + totalPrice;

          itemMap[item] = (itemMap[item] || 0) + 1;
        }

        document.getElementById("totalSpending").textContent = total.toFixed(2) + " р╕Ър╕▓р╕Ч";

        const dailyList = document.getElementById("dailySpending");
        Object.entries(dailyMap).forEach(([date, value]) => {
          const li = document.createElement("li");
          li.textContent = `${date}: ${value.toFixed(2)} р╕Ър╕▓р╕Ч`;
          dailyList.appendChild(li);
        });

        const monthlyList = document.getElementById("monthlySpending");
        Object.entries(monthlyMap).forEach(([month, value]) => {
          const li = document.createElement("li");
          li.textContent = `${month}: ${value.toFixed(2)} р╕Ър╕▓р╕Ч`;
          monthlyList.appendChild(li);
        });

        const topItems = Object.entries(itemMap).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const topList = document.getElementById("topItems");
        topItems.forEach(([item, count]) => {
          const li = document.createElement("li");
          li.textContent = `${item} (${count} р╕Др╕гр╕▒р╣Йр╕З)`;
          topList.appendChild(li);
        });

        // р╕кр╕гр╣Йр╕▓р╕З bar chart
        const barData = new google.visualization.DataTable();
        barData.addColumn('string', 'р╕зр╕▒р╕Щр╕Чр╕╡р╣И');
        barData.addColumn('number', 'р╕вр╕нр╕Фр╕Ир╣Ир╕▓р╕в');
        Object.entries(dailyMap).forEach(([d, v]) => barData.addRow([d, v]));
        new google.visualization.ColumnChart(document.getElementById('barChart')).draw(barData, {
          title: 'р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ'
        });

        // р╕кр╕гр╣Йр╕▓р╕З pie chart
        const pieData = new google.visualization.DataTable();
        pieData.addColumn('string', 'р╕кр╕┤р╕Щр╕Др╣Йр╕▓');
        pieData.addColumn('number', 'р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕гр╕▒р╣Йр╕Зр╕Чр╕╡р╣Ир╕Лр╕╖р╣Йр╕н');
        Object.entries(itemMap).forEach(([k, v]) => pieData.addRow([k, v]));
        new google.visualization.PieChart(document.getElementById('pieChart')).draw(pieData, {
          title: 'р╕кр╕▒р╕Фр╕кр╣Ир╕зр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Лр╕╖р╣Йр╕н'
        });
      });
    }
  </script>
</body>
</html>
