<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2, h3 { margin-top: 1.5em; }
    #controls { margin-bottom: 1em; }
    #controls label { margin-right: .5em; font-weight: bold; }
    #totals p { font-size: 1.2em; margin: .5em 0; }
    canvas { max-width: 100%; margin: 20px 0; }
    .daily-summaries { display: flex; gap: 2em; margin-top: 2em; }
    .summary-col { flex: 1; }
    .summary-col h3 { margin-bottom: 0.5em; }
    .summary-col ul { padding-left: 1em; list-style: disc; }
    table { width: 100%; border-collapse: collapse; margin-top: 2em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>üìä Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>

  <div id="controls">
    <label for="period-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á:</label>
    <select id="period-select">
      <option value="1">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
      <option value="3">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
    </select>
  </div>

  <div id="totals">
    <p>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><span id="total-income">0</span> ‡∏ø</strong></p>
    <p>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><span id="total-expenses">0</span> ‡∏ø</strong></p>
  </div>

  <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2>
  <canvas id="incomeChart"></canvas>

  <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
  <canvas id="expenseChart"></canvas>

  <div class="daily-summaries">
    <div class="summary-col">
      <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
      <ul id="income-daily-list"></ul>
    </div>
    <div class="summary-col">
      <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
      <ul id="expense-daily-list"></ul>
    </div>
  </div>

  <h2>Top 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πà‡∏≠‡∏¢</h2>
  <table id="top-items">
    <thead>
      <tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let gData;
    const monthColors = [
      'rgba(75,192,192,0.6)',
      'rgba(153,102,255,0.6)',
      'rgba(255,159,64,0.6)'
    ];

    // JSONP callback
    function initData(allData) {
      gData = allData;
      document.getElementById('period-select')
              .addEventListener('change', renderAll);
      renderAll();
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô 'YYYY-MM-DD' ‡∏ï‡∏≤‡∏° timezone ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏õ‡πâ
    function localDateKey(val) {
      const d = new Date(val);
      if (!val || isNaN(d)) return null;
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    }
    // ‡πÅ‡∏õ‡∏•‡∏á 'YYYY-MM-DD' ‚Üí 'dd/mm/yy'
    function formatDMY(k) {
      const [yy,mm,dd] = k.split('-');
      return `${dd}/${mm}/${yy.slice(-2)}`;
    }

    // plugin ‡∏ß‡∏≤‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡∏à‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ line
    const labelPlugin = {
      id: 'labelPlugin',
      afterDatasetsDraw(chart) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach((ds,i) => {
          if (ds.type==='line') {
            const meta = chart.getDatasetMeta(i);
            const pts = meta.data;
            const last = pts[pts.length-1];
            if (last && ds.label && ds.showLabel) {
              ctx.fillStyle = ds.borderColor;
              ctx.font = '12px sans-serif';
              ctx.fillText(ds.totalLabel, last.x + 4, last.y - 6);
            }
          }
        });
      }
    };
    Chart.register(labelPlugin);

    let incomeChart, expenseChart;

    function renderAll() {
      const months = Number(document.getElementById('period-select').value);
      renderIncome(months);
      renderExpense(months);
      renderTopItems();
    }

    function renderIncome(periodCount) {
      const raw = gData.IncomeLog.slice(1);
      const map = {};
      raw.forEach(r=>{
        const k = localDateKey(r[0]);
        if (!k) return;
        map[k] = (map[k]||0) + Number(r[1]);
      });
      const allMonths = Array.from(new Set(Object.keys(map).map(k=>k.slice(0,7)))).sort();
      const sel = allMonths.slice(-periodCount);

      // build date array
      const dates = [];
      sel.forEach(m=>{
        const [yy,mm] = m.split('-');
        const last = new Date(yy,mm,0).getDate();
        for(let d=1; d<=last; d++){
          dates.push(`${yy}-${mm}-${String(d).padStart(2,'0')}`);
        }
      });

      const labels = dates.map(formatDMY);
      const values = dates.map(k=>map[k]||0);

      // cumulative per month
      const lineDS = sel.map((m,mi)=>{
        let cum=0;
        const data = dates.map(k=>{
          if(k.slice(0,7)===m){
            cum+= map[k]||0;
            return cum;
          }
          return null;
        });
        return {
          type:'line',
          data,
          borderColor: monthColors[mi%monthColors.length],
          backgroundColor:'transparent',
          yAxisID:'y1',
          showLabel:true,
          totalLabel: cum.toLocaleString()+' ‡∏ø',
          label:`‡∏™‡∏∞‡∏™‡∏° ${m.slice(5,7)}/${m.slice(2,4)}`,
          fill:false,
          pointRadius:3,
          tension:0.3
        };
      });

      // clear daily list
      const incList = document.getElementById('income-daily-list');
      incList.innerHTML='';

      // populate daily list
      dates.forEach((k,i)=>{
        const li = document.createElement('li');
        li.textContent = `${labels[i]}: ${values[i].toLocaleString()} ‡∏ø`;
        incList.appendChild(li);
      });

      // total income
      const tot = values.reduce((s,v)=>s+v,0);
      document.getElementById('total-income').textContent = tot.toLocaleString();

      // bar dataset
      const barDS = {
        type:'bar',
        label:'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô',
        data: values,
        backgroundColor: dates.map(k=>{
          const idx = sel.indexOf(k.slice(0,7));
          return monthColors[idx%monthColors.length];
        }),
        yAxisID:'y0'
      };

      // render chart
      const ctx = document.getElementById('incomeChart');
      if(incomeChart) incomeChart.destroy();
      incomeChart = new Chart(ctx, {
        data:{ labels, datasets:[barDS, ...lineDS] },
        options:{
          scales:{
            y0:{ position:'left', beginAtZero:true, title:{display:true,text:'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'} },
            y1:{ position:'right', beginAtZero:true, title:{display:true,text:'‡∏™‡∏∞‡∏™‡∏°'} }
          }
        }
      });
    }

    function renderExpense(periodCount) {
      const raw = gData.MakroLog.slice(1);
      const map = {};
      raw.forEach(r=>{
        const k = localDateKey(r[0]);
        if (!k) return;
        map[k] = (map[k]||0) + Number(r[7]);
      });
      const allMonths = Array.from(new Set(Object.keys(map).map(k=>k.slice(0,7)))).sort();
      const sel = allMonths.slice(-periodCount);

      const dates=[];
      sel.forEach(m=>{
        const [yy,mm]=m.split('-');
        const last=new Date(yy,mm,0).getDate();
        for(let d=1; d<=last; d++){
          dates.push(`${yy}-${mm}-${String(d).padStart(2,'0')}`);
        }
      });

      const labels = dates.map(formatDMY);
      const values = dates.map(k=>map[k]||0);

      // cumulative lines for expense if desired (optional)
      const lineDS = sel.map((m,mi)=>{
        let cum=0;
        const data = dates.map(k=>{
          if(k.slice(0,7)===m){
            cum+= map[k]||0;
            return cum;
          }
          return null;
        });
        return {
          type:'line',
          data,
          borderColor: monthColors[mi%monthColors.length],
          backgroundColor:'transparent',
          yAxisID:'y1',
          showLabel:true,
          totalLabel: cum.toLocaleString()+' ‡∏ø',
          label:`‡∏™‡∏∞‡∏™‡∏° ${m.slice(5,7)}/${m.slice(2,4)}`,
          fill:false,
          pointRadius:3,
          tension:0.3
        };
      });

      // daily list
      const expList = document.getElementById('expense-daily-list');
      expList.innerHTML='';
      dates.forEach((k,i)=>{
        const li = document.createElement('li');
        li.textContent = `${labels[i]}: ${values[i].toLocaleString()} ‡∏ø`;
        expList.appendChild(li);
      });

      // total expense
      const tot = values.reduce((s,v)=>s+v,0);
      document.getElementById('total-expenses').textContent = tot.toLocaleString();

      const barDS = {
        type:'bar',
        label:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô',
        data: values,
        backgroundColor: dates.map(k=>{
          const idx = sel.indexOf(k.slice(0,7));
          return monthColors[idx%monthColors.length];
        }),
        yAxisID:'y0'
      };

      const ctx = document.getElementById('expenseChart');
      if(expenseChart) expenseChart.destroy();
      expenseChart = new Chart(ctx, {
        data:{ labels, datasets:[barDS, ...lineDS] },
        options:{
          scales:{
            y0:{ position:'left', beginAtZero:true, title:{display:true,text:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'} },
            y1:{ position:'right', beginAtZero:true, title:{display:true,text:'‡∏™‡∏∞‡∏™‡∏°'} }
          }
        }
      });
    }

    function renderTopItems() {
      const raw = gData.MakroLog.slice(1);
      const freq = {};
      raw.forEach(r=>{
        const name = r[2];
        freq[name]= (freq[name]||0)+1;
      });
      const top5 = Object.entries(freq)
                     .sort((a,b)=>b[1]-a[1])
                     .slice(0,5);
      const tbody = document.querySelector('#top-items tbody');
      tbody.innerHTML = '';
      top5.forEach(([name,c])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${c}</td>`;
        tbody.appendChild(tr);
      });
    }
  </script>

  <!-- JSONP ‡∏à‡∏≤‡∏Å Web App -->
  <script 
    src="https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec?callback=initData">
  </script>
</body>
</html>
