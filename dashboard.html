<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2, h3 { margin-top: 1.5em; }
    #controls { margin-bottom: 1em; }
    #controls label { margin-right: .5em; font-weight: bold; }
    #totals p { font-size: 1.2em; margin: .5em 0; }
    canvas { max-width: 100%; margin: 20px 0; }
    ul { padding-left: 1.2em; list-style: disc; }
    .month-header { font-weight: bold; margin-top: .8em; list-style: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>üìä Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>

  <div id="controls">
    <label for="period-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á:</label>
    <select id="period-select">
      <option value="1">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
      <option value="3">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
    </select>
  </div>

  <div id="totals">
    <p>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><span id="total-income">0</span> ‡∏ø</strong></p>
    <p>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><span id="total-expenses">0</span> ‡∏ø</strong></p>
  </div>

  <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2>
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <canvas id="incomeDailyChart"></canvas>

  <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <canvas id="expenseDailyChart"></canvas>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // JSONP callback initialization
    let gData;
    function initData(allData) {
      gData = allData;
      document.getElementById('period-select')
        .addEventListener('change', renderAll);
      renderAll(); // initial render
    }

    // ‡∏ä‡∏∏‡∏î‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    const monthColors = [
      'rgba(75,192,192,0.6)',
      'rgba(153,102,255,0.6)',
      'rgba(255,159,64,0.6)'
    ];

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô 'YYYY-MM-DD' ‡∏ï‡∏≤‡∏° timezone ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    function localDateKey(dateVal) {
      const d = new Date(dateVal);
      if (!dateVal || isNaN(d.getTime())) return null;
      const yy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    }
    // ‡πÅ‡∏õ‡∏•‡∏á 'YYYY-MM-DD' ‚Üí 'dd/mm/yy'
    function formatDMY(dateKey) {
      const [yy, mm, dd] = dateKey.split('-');
      return `${dd}/${mm}/${yy.slice(-2)}`;
    }

    // Plugin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ line dataset
    const labelPlugin = {
      id: 'labelPlugin',
      afterDatasetsDraw(chart) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach((ds, idx) => {
          if (ds.type === 'line' && ds.showLabel) {
            const meta = chart.getDatasetMeta(idx);
            const pts = meta.data;
            const last = pts[pts.length - 1];
            if (last && ds.label) {
              ctx.fillStyle = ds.borderColor;
              ctx.font = '12px sans-serif';
              ctx.fillText(ds.label, last.x + 6, last.y - 4);
            }
          }
        });
      }
    };
    Chart.register(labelPlugin);

    let incChart, expChart;

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å render ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function renderAll() {
      const periodCount = Number(document.getElementById('period-select').value);
      renderIncome(periodCount);
      renderExpense(periodCount);
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô + cumulative line
    function renderIncome(periodCount) {
      const rawInc = gData.IncomeLog.slice(1);
      // map ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
      const incMap = {};
      rawInc.forEach(r => {
        const key = localDateKey(r[0]);
        if (!key) return;
        incMap[key] = (incMap[key]||0) + Number(r[1]);
      });
      // ‡∏´‡∏≤‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      const incMonths = Array.from(
        new Set(Object.keys(incMap).map(k => k.slice(0,7)))
      ).sort();
      const selMonths = incMonths.slice(-periodCount);

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const incDates = [];
      selMonths.forEach(month => {
        const [yy, mm] = month.split('-');
        const lastDay = new Date(yy, mm, 0).getDate();
        for (let d = 1; d <= lastDay; d++) {
          const dd = String(d).padStart(2,'0');
          incDates.push(`${yy}-${mm}-${dd}`);
        }
      });

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì daily values + monthly summary + cumulative
      const incLabels = incDates.map(formatDMY);
      const incValues = incDates.map(key => incMap[key]||0);
      const incMonthlySum = {};
      selMonths.forEach((m,mi) => {
        let cum = 0;
        incDates.forEach((key,i) => {
          if (key.slice(0,7) === m) {
            cum += incMap[key]||0;
            incMonthlySum[m] = (incMonthlySum[m]||0) + (incMap[key]||0);
          }
        });
      });

      // ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°
      const totalInc = incValues.reduce((s,v) => s+v,0);
      document.getElementById('total-income').textContent = totalInc.toLocaleString();

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° datasets
      const barDataset = {
        type: 'bar',
        label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô',
        data: incValues,
        backgroundColor: incDates.map(key => {
          const mi = selMonths.indexOf(key.slice(0,7));
          return monthColors[mi % monthColors.length];
        })
      };
      const lineDatasets = selMonths.map((m,mi) => {
        let sum = 0;
        const data = incDates.map(key => {
          if (key.slice(0,7) === m) {
            sum += incMap[key]||0;
            return sum;
          }
          return null;
        });
        return {
          type: 'line',
          label: `‡∏™‡∏∞‡∏™‡∏° ${m.slice(5,7)}/${m.slice(2,4)}`,
          data,
          borderColor: monthColors[mi % monthColors.length],
          backgroundColor: 'transparent',
          showLine: true,
          showLabel: true,
          fill: false,
          tension: 0.3,
          pointRadius: 3
        };
      });

      // render Chart
      const ctx = document.getElementById('incomeDailyChart');
      if (incChart) incChart.destroy();
      incChart = new Chart(ctx, {
        data: {
          labels: incLabels,
          datasets: [barDataset, ...lineDatasets]
        },
        options: {
          scales: { x: { display: true }, y: { beginAtZero: true } }
        }
      });
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ cumulative line)
    function renderExpense(periodCount) {
      const rawExp = gData.MakroLog.slice(1);
      const expMap = {};
      rawExp.forEach(r => {
        const key = localDateKey(r[0]);
        if (!key) return;
        expMap[key] = (expMap[key]||0) + Number(r[7]);
      });
      const expMonths = Array.from(
        new Set(Object.keys(expMap).map(k => k.slice(0,7)))
      ).sort();
      const selMonths = expMonths.slice(-periodCount);

      const expDates = [];
      selMonths.forEach(month => {
        const [yy, mm] = month.split('-');
        const lastDay = new Date(yy, mm, 0).getDate();
        for (let d = 1; d <= lastDay; d++) {
          expDates.push(`${yy}-${mm}-${String(d).padStart(2,'0')}`);
        }
      });

      const expLabels = expDates.map(formatDMY);
      const expValues = expDates.map(key => expMap[key]||0);

      const totalExp = expValues.reduce((s,v) => s+v,0);
      document.getElementById('total-expenses').textContent = totalExp.toLocaleString();

      const barDataset = {
        type: 'bar',
        label: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô',
        data: expValues,
        backgroundColor: expDates.map(key => {
          const mi = selMonths.indexOf(key.slice(0,7));
          return monthColors[mi % monthColors.length];
        })
      };

      const ctx = document.getElementById('expenseDailyChart');
      if (expChart) expChart.destroy();
      expChart = new Chart(ctx, {
        data: {
          labels: expLabels,
          datasets: [barDataset]
        },
        options: {
          scales: { x: { display: true }, y: { beginAtZero: true } }
        }
      });
    }
  </script>

  <!-- JSONP ‡∏à‡∏≤‡∏Å Web App ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡πâ -->
  <script src="https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec?callback=initData"></script>
</body>
</html>
