<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Dashboard р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ъ-р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2, h3 { margin-top: 1.5em; }
    #totals p { font-size: 1.2em; margin: 0.5em 0; }
    canvas { max-width: 600px; margin: 20px 0; }
    ul { padding-left: 1.2em; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>ЁЯУК Dashboard р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ъ-р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в</h1>

  <div id="totals">
    <p>р╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: <strong><span id="total-income">0</span> р╕┐</strong></p>
    <p>р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: <strong><span id="total-expenses">0</span> р╕┐</strong></p>
  </div>

  <h2>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ъ</h2>
  <h3>р╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щ</h3>
  <canvas id="incomeDailyChart"></canvas>
  <h3>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щ</h3>
  <ul id="income-daily-summary"></ul>
  <h3>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ</h3>
  <ul id="income-monthly-summary"></ul>

  <h2>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в</h2>
  <h3>р╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ</h3>
  <canvas id="dailyChart"></canvas>
  <h3>р╕Бр╕гр╕▓р╕Яр╕кр╕▒р╕Фр╕кр╣Ир╕зр╕Щр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕┤р╕Щр╕Др╣Йр╕▓</h3>
  <canvas id="categoryChart"></canvas>
  <h3>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ</h3>
  <ul id="daily-summary"></ul>
  <h3>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ</h3>
  <ul id="monthly-summary"></ul>
  <h3>Top 5 р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Лр╕╖р╣Йр╕нр╕Ър╣Ир╕нр╕в</h3>
  <table id="top-items">
    <thead>
      <tr><th>р╕кр╕┤р╕Щр╕Др╣Йр╕▓</th><th>р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕гр╕▒р╣Йр╕З</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- р╣Вр╕лр╕ер╕Ф Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╣Ир╕Щ callback р╕кр╕│р╕лр╕гр╕▒р╕Ъ JSONP
    function renderDashboard(allData) {
      // р╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕гр╕▓р╕вр╕гр╕▒р╕Ъ
      const rawInc = allData.IncomeLog.slice(1);
      const incomes = rawInc.map(r => ({
        date: r[0],
        amount: Number(r[1])
      }));
      // р╕Др╕│р╕Щр╕зр╕Ур╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕зр╕б
      const totalInc = incomes.reduce((sum, i) => sum + i.amount, 0);
      document.getElementById('total-income').textContent = totalInc.toLocaleString();

      // р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щ
      const incDailyMap = {};
      incomes.forEach(i => {
        incDailyMap[i.date] = (incDailyMap[i.date] || 0) + i.amount;
      });
      const incDailyLabels = Object.keys(incDailyMap).sort();
      const incDailyValues = incDailyLabels.map(d => incDailyMap[d]);

      // р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ
      const incMonthlyMap = {};
      incDailyLabels.forEach(d => {
        const m = d.slice(0,7); // YYYY-MM
        incMonthlyMap[m] = (incMonthlyMap[m] || 0) + incDailyMap[d];
      });

      // р╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в
      const rawExp = allData.MakroLog.slice(1);
      const expenses = rawExp.map(r => ({
        purchaseDate: r[0],
        itemName:     r[2],
        category:     r[3],
        quantity:     r[4],
        unitPrice:    r[6],
        totalPrice:   Number(r[7])
      }));
      // р╕Др╕│р╕Щр╕зр╕Ур╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕зр╕б
      const totalExp = expenses.reduce((sum, e) => sum + e.totalPrice, 0);
      document.getElementById('total-expenses').textContent = totalExp.toLocaleString();

      // р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ
      const expDailyMap = {};
      expenses.forEach(e => {
        expDailyMap[e.purchaseDate] = (expDailyMap[e.purchaseDate] || 0) + e.totalPrice;
      });
      const expDailyLabels = Object.keys(expDailyMap).sort();
      const expDailyValues = expDailyLabels.map(d => expDailyMap[d]);

      // р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ
      const expMonthlyMap = {};
      expDailyLabels.forEach(d => {
        const m = d.slice(0,7);
        expMonthlyMap[m] = (expMonthlyMap[m] || 0) + expDailyMap[d];
      });

      // р╕кр╕▒р╕Фр╕кр╣Ир╕зр╕Щр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕┤р╕Щр╕Др╣Йр╕▓
      const categoryMap = {};
      expenses.forEach(e => {
        categoryMap[e.category] = (categoryMap[e.category] || 0) + e.totalPrice;
      });
      const categoryLabels = Object.keys(categoryMap);
      const categoryValues = categoryLabels.map(c => categoryMap[c]);

      // Top 5 р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Лр╕╖р╣Йр╕нр╕Ър╣Ир╕нр╕в
      const freq = {};
      expenses.forEach(e => {
        freq[e.itemName] = (freq[e.itemName] || 0) + 1;
      });
      const top5 = Object.entries(freq)
        .sort((a,b) => b[1] - a[1])
        .slice(0,5);

      // р╕зр╕▓р╕Фр╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щ
      new Chart(document.getElementById('incomeDailyChart'), {
        type: 'bar',
        data: {
          labels: incDailyLabels,
          datasets: [{ label: 'р╕┐', data: incDailyValues }]
        }
      });
      // р╕зр╕▓р╕Фр╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ
      new Chart(document.getElementById('dailyChart'), {
        type: 'bar',
        data: {
          labels: expDailyLabels,
          datasets: [{ label: 'р╕┐', data: expDailyValues }]
        }
      });
      // р╕зр╕▓р╕Фр╕Бр╕гр╕▓р╕Яр╕кр╕▒р╕Фр╕кр╣Ир╕зр╕Щр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И
      new Chart(document.getElementById('categoryChart'), {
        type: 'pie',
        data: {
          labels: categoryLabels,
          datasets: [{ data: categoryValues }]
        }
      });

      // р╣Ар╕Хр╕┤р╕бр╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ър╣Ар╕Ыр╣Зр╕Щ list
      const incDailyList = document.getElementById('income-daily-summary');
      incDailyLabels.forEach(d => {
        const li = document.createElement('li');
        li.textContent = `${d}: ${incDailyMap[d].toLocaleString()} р╕┐`;
        incDailyList.appendChild(li);
      });
      const incMonthlyList = document.getElementById('income-monthly-summary');
      Object.keys(incMonthlyMap).sort().forEach(m => {
        const li = document.createElement('li');
        li.textContent = `${m}: ${incMonthlyMap[m].toLocaleString()} р╕┐`;
        incMonthlyList.appendChild(li);
      });

      // р╣Ар╕Хр╕┤р╕бр╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╣Ар╕Ыр╣Зр╕Щ list
      const expDailyList = document.getElementById('daily-summary');
      expDailyLabels.forEach(d => {
        const li = document.createElement('li');
        li.textContent = `${d}: ${expDailyMap[d].toLocaleString()} р╕┐`;
        expDailyList.appendChild(li);
      });
      const expMonthlyList = document.getElementById('monthly-summary');
      Object.keys(expMonthlyMap).sort().forEach(m => {
        const li = document.createElement('li');
        li.textContent = `${m}: ${expMonthlyMap[m].toLocaleString()} р╕┐`;
        expMonthlyList.appendChild(li);
      });

      // р╣Ар╕Хр╕┤р╕б Top 5 р╕кр╕┤р╕Щр╕Др╣Йр╕▓
      const tbody = document.querySelector('#top-items tbody');
      top5.forEach(([name, count]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${count}</td>`;
        tbody.appendChild(tr);
      });
    }
  </script>

  <!-- р╣Ар╕гр╕╡р╕вр╕Б JSONP р╕Ир╕▓р╕Б GAS р╕Фр╣Йр╕зр╕в callback=renderDashboard -->
  <script src="https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec?callback=renderDashboard"></script>
</body>
</html>
