<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2, h3 { margin-top: 1.5em; }
    #totals p { font-size: 1.2em; margin: .5em 0; }
    canvas { max-width: 600px; margin: 20px 0; }
    ul { padding-left: 1.2em; list-style: disc; }
    .month-header { font-weight: bold; margin-top: .8em; list-style: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>üìä Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>

  <div id="totals">
    <p>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><span id="total-income">0</span> ‡∏ø</strong></p>
    <p>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><span id="total-expenses">0</span> ‡∏ø</strong></p>
  </div>

  <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2>
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <canvas id="incomeDailyChart"></canvas>
  <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <ul id="income-daily-summary"></ul>
  <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
  <ul id="income-monthly-summary"></ul>

  <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <canvas id="expenseDailyChart"></canvas>
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
  <canvas id="categoryChart"></canvas>
  <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <ul id="expense-daily-summary"></ul>
  <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
  <ul id="expense-monthly-summary"></ul>

  <h2>Top 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πà‡∏≠‡∏¢</h2>
  <table id="top-items">
    <thead><tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ‡πÅ‡∏õ‡∏•‡∏á 'YYYY-MM-DD' ‚Üí 'dd/mm/yy'
    function formatDMY(dateKey) {
      const [yy, mm, dd] = dateKey.split('-');
      return `${dd}/${mm}/${yy.slice(-2)}`;
    }

    function renderDashboard(allData) {
      // --- ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ---
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á map ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô (YYYY-MM-DD)
      const rawInc = allData.IncomeLog.slice(1);
      const incMap = {};
      rawInc.forEach(r => {
        const dateVal = r[0];
        const d = new Date(dateVal);
        if (!dateVal || isNaN(d.getTime())) return;
        const key = d.toISOString().slice(0,10);
        incMap[key] = (incMap[key]||0) + Number(r[1]);
      });
      // ‡∏´‡∏≤‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
      const incMonths = Array.from(
        new Set(Object.keys(incMap).map(k => k.slice(0,7)))
      ).sort();

      const incDailySummary = document.getElementById('income-daily-summary');
      incDailySummary.innerHTML = '';
      const incMonthlySummaryMap = {};
      const incLabels = [];
      const incValues = [];

      incMonths.forEach(month => {
        const [yy, mm] = month.split('-');
        // ‡∏´‡∏±‡∏ß‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        const h = document.createElement('li');
        h.textContent = `‚Äî ${mm}/${yy.slice(-2)}`;
        h.classList.add('month-header');
        incDailySummary.appendChild(h);

        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        const lastDay = new Date(yy, mm, 0).getDate();
        for (let d = 1; d <= lastDay; d++) {
          const dd = String(d).padStart(2,'0');
          const key = `${yy}-${mm}-${dd}`;
          const amt = incMap[key] || 0;

          // ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
          const li = document.createElement('li');
          li.textContent = `${formatDMY(key)}: ${amt.toLocaleString()} ‡∏ø`;
          incDailySummary.appendChild(li);

          // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
          const monLabel = `${mm}/${yy.slice(-2)}`;
          incMonthlySummaryMap[monLabel] = (incMonthlySummaryMap[monLabel]||0) + amt;

          // ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
          incLabels.push(formatDMY(key));
          incValues.push(amt);
        }
      });

      // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
      const totalInc = incValues.reduce((s,v) => s+v, 0);
      document.getElementById('total-income').textContent = totalInc.toLocaleString();

      // ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
      const incMonthlySummary = document.getElementById('income-monthly-summary');
      Object.keys(incMonthlySummaryMap).sort().forEach(mon => {
        const li = document.createElement('li');
        li.textContent = `${mon}: ${incMonthlySummaryMap[mon].toLocaleString()} ‡∏ø`;
        incMonthlySummary.appendChild(li);
      });

      // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
      new Chart(document.getElementById('incomeDailyChart'), {
        type: 'bar',
        data: { labels: incLabels, datasets: [{ label: '‡∏ø', data: incValues }] }
      });

      // --- ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ---
      const rawExp = allData.MakroLog.slice(1);
      const expMap = {};
      rawExp.forEach(r => {
        const dateVal = r[0];
        const d = new Date(dateVal);
        if (!dateVal || isNaN(d.getTime())) return;
        const key = d.toISOString().slice(0,10);
        expMap[key] = (expMap[key]||0) + Number(r[7]);
      });
      const expMonths = Array.from(
        new Set(Object.keys(expMap).map(k => k.slice(0,7)))
      ).sort();

      const expDailySummary = document.getElementById('expense-daily-summary');
      expDailySummary.innerHTML = '';
      const expMonthlySummaryMap = {};
      const expLabels = [];
      const expValues = [];

      expMonths.forEach(month => {
        const [yy, mm] = month.split('-');
        const h = document.createElement('li');
        h.textContent = `‚Äî ${mm}/${yy.slice(-2)}`;
        h.classList.add('month-header');
        expDailySummary.appendChild(h);

        const lastDay = new Date(yy, mm, 0).getDate();
        for (let d = 1; d <= lastDay; d++) {
          const dd = String(d).padStart(2,'0');
          const key = `${yy}-${mm}-${dd}`;
          const amt = expMap[key] || 0;

          const li = document.createElement('li');
          li.textContent = `${formatDMY(key)}: ${amt.toLocaleString()} ‡∏ø`;
          expDailySummary.appendChild(li);

          const monLabel = `${mm}/${yy.slice(-2)}`;
          expMonthlySummaryMap[monLabel] = (expMonthlySummaryMap[monLabel]||0) + amt;

          expLabels.push(formatDMY(key));
          expValues.push(amt);
        }
      });

      const totalExp = expValues.reduce((s,v) => s+v, 0);
      document.getElementById('total-expenses').textContent = totalExp.toLocaleString();

      const expMonthlySummary = document.getElementById('expense-monthly-summary');
      Object.keys(expMonthlySummaryMap).sort().forEach(mon => {
        const li = document.createElement('li');
        li.textContent = `${mon}: ${expMonthlySummaryMap[mon].toLocaleString()} ‡∏ø`;
        expMonthlySummary.appendChild(li);
      });

      // ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
      new Chart(document.getElementById('expenseDailyChart'), {
        type: 'bar',
        data: { labels: expLabels, datasets: [{ label: '‡∏ø', data: expValues }] }
      });

      // ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
      const categoryMap = {};
      rawExp.forEach(r => {
        const cat = r[3];
        categoryMap[cat] = (categoryMap[cat]||0) + Number(r[7]);
      });
      const catLabels = Object.keys(categoryMap);
      const catValues = catLabels.map(c => categoryMap[c]);
      new Chart(document.getElementById('categoryChart'), {
        type: 'pie',
        data: { labels: catLabels, datasets: [{ data: catValues }] }
      });

      // Top 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πà‡∏≠‡∏¢
      const freq = {};
      rawExp.forEach(r => {
        const name = r[2];
        freq[name] = (freq[name]||0) + 1;
      });
      const top5 = Object.entries(freq)
        .sort((a,b) => b[1]-a[1])
        .slice(0,5);
      const tbody = document.querySelector('#top-items tbody');
      tbody.innerHTML = '';
      top5.forEach(([name,count]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${count}</td>`;
        tbody.appendChild(tr);
      });
    }
  </script>
  <!-- ‡∏£‡∏±‡∏ô JSONP ‡∏à‡∏≤‡∏Å Web App ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡πâ -->
  <script src="https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec?callback=renderDashboard"></script>
</body>
</html>
