<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Dashboard à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸£à¸±à¸šâ€“à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2, h3 { margin-top: 1.5em; }
    #controls { display: flex; gap: 2em; align-items: center; margin-bottom: 1em; }
    #controls div { display: flex; align-items: center; gap: .5em; }
    #totals p { font-size: 1.2em; margin: .5em 0; }
    #daily-summary-container { display: flex; gap: 40px; margin-top: 2em; }
    #daily-summary-container > div { flex: 1; }
    ul { padding-left: 1.2em; list-style: disc; }
    .month-header { font-weight: bold; margin-top: .8em; list-style: none; }
    canvas { max-width: 100%; margin: 20px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 2em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Dashboard à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸£à¸±à¸šâ€“à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</h1>

  <div id="totals">
    <p>à¸£à¸²à¸¢à¸£à¸±à¸šà¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: <strong><span id="total-income">0</span> à¸¿</strong></p>
    <p>à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: <strong><span id="total-expenses">0</span> à¸¿</strong></p>
  </div>

  <h2>à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸£à¸±à¸š</h2>
  <div id="controls">
    <div>
      <label for="income-period">à¸Šà¹ˆà¸§à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥:</label>
      <select id="income-period">
        <option value="1">1 à¹€à¸”à¸·à¸­à¸™</option>
        <option value="3">3 à¹€à¸”à¸·à¸­à¸™</option>
      </select>
    </div>
  </div>
  <canvas id="incomeDailyChart"></canvas>

  <h2>à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</h2>
  <div id="controls">
    <div>
      <label for="expense-period">à¸Šà¹ˆà¸§à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥:</label>
      <select id="expense-period">
        <option value="1">1 à¹€à¸”à¸·à¸­à¸™</option>
        <option value="3">3 à¹€à¸”à¸·à¸­à¸™</option>
      </select>
    </div>
  </div>
  <canvas id="expenseDailyChart"></canvas>

  <div id="daily-summary-container">
    <div>
      <h3>à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸£à¸±à¸šà¸£à¸²à¸¢à¸§à¸±à¸™</h3>
      <ul id="income-daily-summary"></ul>
    </div>
    <div>
      <h3>à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™</h3>
      <ul id="expense-daily-summary"></ul>
    </div>
  </div>

  <h3>à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆà¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</h3>
  <canvas id="expenseCategoryChart"></canvas>

  <h3>à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‹à¸·à¹‰à¸­à¸šà¹ˆà¸­à¸¢ 5 à¸­à¸±à¸™à¸”à¸±à¸š</h3>
  <table id="top-items">
    <thead><tr><th>à¸ªà¸´à¸™à¸„à¹‰à¸²</th><th>à¸ˆà¸³à¸™à¸§à¸™à¸„à¸£à¸±à¹‰à¸‡</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let gData, incChart, expChart;

    // JSONP callback
    function initData(allData) {
      gData = allData;
      document.getElementById('income-period').addEventListener('change', renderIncome);
      document.getElementById('expense-period').addEventListener('change', renderExpense);
      renderIncome();
      renderExpense();
    }

    // Colors
    const coolColors = [ 'rgba(54,162,235,0.6)', 'rgba(75,192,192,0.6)', 'rgba(153,217,234,0.6)' ];
    const hotColors  = [ 'rgba(255,99,132,0.6)', 'rgba(255,159,64,0.6)', 'rgba(255,205,86,0.6)' ];

    // Label plugin for final points
    const labelPlugin = {
      id: 'labelPlugin',
      afterDatasetsDraw(chart) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach((ds, idx) => {
          if (ds.type === 'line' && ds.showLabel) {
            const meta = chart.getDatasetMeta(idx);
            const pts = meta.data;
            const last = pts[pts.length - 1];
            if (last && ds.label) {
              ctx.fillStyle = ds.borderColor;
              ctx.font = '12px sans-serif';
              ctx.fillText(ds.label, last.x + 4, last.y - 4);
            }
          }
        });
      }
    };
    Chart.register(labelPlugin);

    // Date helpers
    function localDateKey(dateVal) {
      const d = new Date(dateVal);
      if (!dateVal || isNaN(d.getTime())) return null;
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    }
    function formatDMY(key) {
      const [yy,mm,dd] = key.split('-');
      return `${dd}/${mm}/${yy.slice(-2)}`;
    }

    function renderIncome() {
      const period = +document.getElementById('income-period').value;
      // build map
      const map = {};
      gData.IncomeLog.slice(1).forEach(r => {
        const key = localDateKey(r[0]);
        if (!key) return;
        map[key] = (map[key]||0) + +r[1];
      });
      // months & dates
      const months = Array.from(new Set(Object.keys(map).map(k=>k.slice(0,7)))).sort().slice(-period);
      const dates = [];
      months.forEach(m=>{
        const [yy,mm] = m.split('-');
        const last = new Date(yy,mm,0).getDate();
        for(let d=1;d<=last;d++){
          dates.push(`${yy}-${mm}-${String(d).padStart(2,'0')}`);
        }
      });
      const labels = dates.map(formatDMY);
      const values = dates.map(d=>map[d]||0);
      // total
      document.getElementById('total-income').textContent = values.reduce((a,b)=>a+b,0).toLocaleString();
      // summary list
      const sumEl = document.getElementById('income-daily-summary');
      sumEl.innerHTML = '';
      dates.forEach((d,i)=>{
        const li = document.createElement('li');
        li.textContent = `${labels[i]}: ${values[i].toLocaleString()} à¸¿`;
        sumEl.appendChild(li);
      });
      // datasets
      const bar = {
        type:'bar', label:'à¸£à¸²à¸¢à¸£à¸±à¸šà¸£à¸²à¸¢à¸§à¸±à¸™',
        data: values,
        backgroundColor: dates.map(d=>{
          const mi = months.indexOf(d.slice(0,7)); return coolColors[mi%coolColors.length];
        })
      };
      const lines = months.map((m,idx)=>{
        let cum=0;
        const data = dates.map(d=>{
          if(d.slice(0,7)===m){ cum+=map[d]||0; return cum; }
          return null;
        });
        return {
          type:'line',
          label: cum.toLocaleString(),
          data, borderColor: coolColors[idx%coolColors.length],
          backgroundColor:'transparent', showLabel:true,
          yAxisID:'y1', fill:false, tension:0.3, pointRadius:3
        };
      });
      // chart
      const ctx = document.getElementById('incomeDailyChart');
      if(incChart) incChart.destroy();
      incChart = new Chart(ctx,{ data:{labels, datasets:[bar,...lines]},
        options:{
          scales:{
            y:{ beginAtZero:true, title:{display:true,text:'à¸£à¸²à¸¢à¸£à¸±à¸š (à¸¿)'} },
            y1:{ position:'right', beginAtZero:true, grid:{drawOnChartArea:false},
                 title:{display:true,text:'à¸¢à¸­à¸”à¸ªà¸°à¸ªà¸¡ (à¸¿)'} }
          }
        }
      });
    }

    function renderExpense() {
      const period = +document.getElementById('expense-period').value;
      const map = {};
      gData.MakroLog.slice(1).forEach(r=>{
        const key = localDateKey(r[0]);
        if(!key) return;
        map[key] = (map[key]||0)+ +r[7];
      });
      const months = Array.from(new Set(Object.keys(map).map(k=>k.slice(0,7)))).sort().slice(-period);
      const dates = [];
      months.forEach(m=>{
        const [yy,mm] = m.split('-');
        const last = new Date(yy,mm,0).getDate();
        for(let d=1;d<=last;d++){
          dates.push(`${yy}-${mm}-${String(d).padStart(2,'0')}`);
        }
      });
      const labels = dates.map(formatDMY);
      const values = dates.map(d=>map[d]||0);
      document.getElementById('total-expenses').textContent = values.reduce((a,b)=>a+b,0).toLocaleString();
      const sumEl = document.getElementById('expense-daily-summary');
      sumEl.innerHTML = '';
      dates.forEach((d,i)=>{
        const li = document.createElement('li');
        li.textContent = `${labels[i]}: ${values[i].toLocaleString()} à¸¿`;
        sumEl.appendChild(li);
      });
      // bar chart
      const bar = {
        type:'bar', label:'à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™',
        data: values,
        backgroundColor: dates.map(d=>{
          const mi = months.indexOf(d.slice(0,7)); return hotColors[mi%hotColors.length];
        })
      };
      // cumulative line
      const lines = months.map((m,idx)=>{
        let cum=0;
        const data = dates.map(d=>{
          if(d.slice(0,7)===m){ cum+=map[d]||0; return cum; }
          return null;
        });
        return {
          type:'line',
          label: cum.toLocaleString(),
          data, borderColor: hotColors[idx%hotColors.length],
          backgroundColor:'transparent', showLabel:true,
          yAxisID:'y1', fill:false, tension:0.3, pointRadius:3
        };
      });
      // chart
      const ctx = document.getElementById('expenseDailyChart');
      if(expChart) expChart.destroy();
      expChart = new Chart(ctx,{ data:{labels, datasets:[bar,...lines]},
        options:{
          scales:{
            y:{ beginAtZero:true, title:{display:true,text:'à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢ (à¸¿)'} },
            y1:{ position:'right', beginAtZero:true, grid:{drawOnChartArea:false},
                 title:{display:true,text:'à¸¢à¸­à¸”à¸ªà¸°à¸ªà¸¡ (à¸¿)'} }
          }
        }
      });
      // pie chart of categories
      const catMap = {};
      gData.MakroLog.slice(1).forEach(r=>{
        const cat = r[3];
        catMap[cat] = (catMap[cat]||0)+ +r[7];
      });
      const catLabels = Object.keys(catMap);
      const catValues = catLabels.map(c=>catMap[c]);
      const ctx2 = document.getElementById('expenseCategoryChart');
      new Chart(ctx2,{ type:'pie', data:{labels:catLabels, datasets:[{data:catValues,
        backgroundColor: hotColors }] } });
      // top 5 items
      const freq = {};
      gData.MakroLog.slice(1).forEach(r=>{
        freq[r[2]] = (freq[r[2]]||0)+1;
      });
      const top5 = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,5);
      const tb = document.querySelector('#top-items tbody');
      tb.innerHTML = '';
      top5.forEach(([name,c])=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${name}</td><td>${c}</td>`;
        tb.appendChild(tr);
      });
    }
  </script>
  <!-- JSONP à¸ˆà¸²à¸ Web App -->
  <script src="https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec?callback=initData"></script>
</body>
</html>
