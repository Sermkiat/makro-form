<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Dashboard р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ъ-р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2, h3 { margin-top: 1.5em; }
    #totals p { font-size: 1.2em; margin: .5em 0; }
    canvas { max-width: 600px; margin: 20px 0; }
    ul { padding-left: 1.2em; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .month-header { font-weight: bold; margin-top: .8em; }
  </style>
</head>
<body>
  <h1>ЁЯУК Dashboard р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ъ-р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в</h1>

  <div id="totals">
    <p>р╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: <strong><span id="total-income">0</span> р╕┐</strong></p>
    <p>р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: <strong><span id="total-expenses">0</span> р╕┐</strong></p>
  </div>

  <h2>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ъ</h2>
  <h3>р╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щ</h3>
  <canvas id="incomeDailyChart"></canvas>
  <h3>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щ</h3>
  <ul id="income-daily-summary"></ul>
  <h3>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ</h3>
  <ul id="income-monthly-summary"></ul>

  <h2>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в</h2>
  <h3>р╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ</h3>
  <canvas id="dailyChart"></canvas>
  <h3>р╕Бр╕гр╕▓р╕Яр╕кр╕▒р╕Фр╕кр╣Ир╕зр╕Щр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕┤р╕Щр╕Др╣Йр╕▓</h3>
  <canvas id="categoryChart"></canvas>
  <h3>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ</h3>
  <ul id="daily-summary"></ul>
  <h3>р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ</h3>
  <ul id="monthly-summary"></ul>
  <h3>Top 5 р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Лр╕╖р╣Йр╕нр╕Ър╣Ир╕нр╕в</h3>
  <table id="top-items">
    <thead><tr><th>р╕кр╕┤р╕Щр╕Др╣Йр╕▓</th><th>р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕гр╕▒р╣Йр╕З</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- р╣Вр╕лр╕ер╕Ф Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // format dd/mm/yy
    function formatDMY(dateKey) {
      const [y, m, d] = dateKey.split('-');
      return `${d.padStart(2,'0')}/${m}/${y.slice(-2)}`;
    }

    function renderDashboard(allData) {
      // 1. р╣Бр╕Ыр╕ер╕З raw income тЖТ map by dateKey (YYYY-MM-DD)
      const rawInc = allData.IncomeLog.slice(1);
      const incMap = {};
      rawInc.forEach(r => {
        const key = new Date(r[0]).toISOString().slice(0,10);
        incMap[key] = (incMap[key]||0) + Number(r[1]);
      });

      // р╕лр╕▓р╕Кр╣Ир╕зр╕Зр╣Ар╕Фр╕╖р╕нр╕Щ-р╕Ыр╕╡ р╕Чр╕╡р╣Ир╕бр╕╡р╣Гр╕Щ incMap
      const months = Array.from(
        new Set(Object.keys(incMap).map(k => k.slice(0,7)))
      ).sort();

      // р╕кр╕гр╣Йр╕▓р╕З list р╕Вр╕нр╕Зр╕Чр╕╕р╕Бр╕зр╕▒р╕Щр╣Гр╕Щр╣Бр╕Хр╣Ир╕ер╕░р╣Ар╕Фр╕╖р╕нр╕Щ
      const incDailySummary = document.getElementById('income-daily-summary');
      incDailySummary.innerHTML = '';  // р╣Ар╕Др╕ер╕╡р╕вр╕гр╣Мр╕Бр╣Ир╕нр╕Щ
      const incMonthlyMap = {};

      // р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕▓р╕Я р╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щ: р╣Ар╕Бр╣Зр╕Ъ label + data
      const incLabels = [];
      const incValues = [];

      months.forEach(month => {
        // р╣Гр╕кр╣Ир╕лр╕▒р╕зр╣Ар╕Фр╕╖р╕нр╕Щ
        const [yy, mm] = month.split('-');
        const monthHeader = document.createElement('li');
        monthHeader.textContent = `${mm}/${yy.slice(-2)}`;
        monthHeader.classList.add('month-header');
        incDailySummary.appendChild(monthHeader);

        // р╕зр╕▒р╕Щр╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕вр╕Вр╕нр╕Зр╣Ар╕Фр╕╖р╕нр╕Щ
        const lastDay = new Date(yy, mm, 0).getDate();
        for (let d = 1; d <= lastDay; d++) {
          const dd = String(d).padStart(2,'0');
          const dateKey = `${yy}-${mm}-${dd}`;
          const amt = incMap[dateKey] || 0;

          // р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕зр╕▒р╕Щ
          const li = document.createElement('li');
          li.textContent = `${formatDMY(dateKey)}: ${amt.toLocaleString()} р╕┐`;
          incDailySummary.appendChild(li);

          // р╣Ар╕Бр╣Зр╕Ър╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ
          const monLabel = `${mm}/${yy.slice(-2)}`;
          incMonthlyMap[monLabel] = (incMonthlyMap[monLabel]||0) + amt;

          // р╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕гр╕▓р╕Я
          incLabels.push(formatDMY(dateKey));
          incValues.push(amt);
        }
      });

      // р╣Бр╕кр╕Фр╕Зр╕вр╕нр╕Фр╕гр╕зр╕бр╕гр╕▓р╕вр╕гр╕▒р╕Ъ
      const totalInc = incValues.reduce((s,v) => s+v, 0);
      document.getElementById('total-income').textContent = totalInc.toLocaleString();

      // р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ
      const incMonthlySummary = document.getElementById('income-monthly-summary');
      Object.keys(incMonthlyMap).sort().forEach(mon => {
        const li = document.createElement('li');
        li.textContent = `${mon}: ${incMonthlyMap[mon].toLocaleString()} р╕┐`;
        incMonthlySummary.appendChild(li);
      });

      // р╕зр╕▓р╕Фр╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕гр╕▒р╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щ
      new Chart(document.getElementById('incomeDailyChart'), {
        type: 'bar',
        data: { labels: incLabels, datasets: [{ label: 'р╕┐', data: incValues }] }
      });

      // тАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФтАФ
      // (р╕кр╣Ир╕зр╕Щр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ р╣Бр╕Хр╣Ир╕нр╕▓р╕Ир╕нр╕вр╕▓р╕Бр╣Гр╕Кр╣Йр╕зр╕┤р╕Шр╕╡р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щр╕Цр╣Йр╕▓р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Ар╕Хр╕┤р╕бр╕зр╕▒р╕Щр╣Гр╕лр╣Йр╕Др╕гр╕Ъ)
      // тАж (р╣Ар╕Бр╣Зр╕Ъ expMap, expLabels, expValues, р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в р╕пр╕ер╕п р╣Ар╕лр╕бр╕╖р╕нр╕Щр╣Ар╕Фр╕┤р╕б) тАж
    }
  </script>

  <!-- р╣Ар╕гр╕╡р╕вр╕Б JSONP р╕Ир╕▓р╕Б GAS -->
  <script src="https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec?callback=renderDashboard"></script>
</body>
</html>
