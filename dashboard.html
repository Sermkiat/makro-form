<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2, h3 { margin-top: 1.5em; }
    #totals p { font-size: 1.2em; margin: 0.5em 0; }
    canvas { max-width: 600px; margin: 20px 0; }
    ul { padding-left: 1.2em; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>üìä Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>

  <div id="totals">
    <p>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><span id="total-income">0</span> ‡∏ø</strong></p>
    <p>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><span id="total-expenses">0</span> ‡∏ø</strong></p>
  </div>

  <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2>
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <canvas id="incomeDailyChart"></canvas>
  <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <ul id="income-daily-summary"></ul>
  <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
  <ul id="income-monthly-summary"></ul>

  <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <canvas id="dailyChart"></canvas>
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
  <canvas id="categoryChart"></canvas>
  <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
  <ul id="daily-summary"></ul>
  <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
  <ul id="monthly-summary"></ul>
  <h3>Top 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πà‡∏≠‡∏¢</h3>
  <table id="top-items">
    <thead>
      <tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ‡πÇ‡∏´‡∏•‡∏î Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢ format ‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô dd/mm/yy
    function formatDateLabel(date) {
      const d = new Date(date);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}/${mm}/${yy}`;
    }

    // callback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JSONP
    function renderDashboard(allData) {
      // ‚Äì ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
      const rawInc = allData.IncomeLog.slice(1);
      const incMap  = {};
      rawInc.forEach(r => {
        const key = r[0]; // ‡πÄ‡∏ä‡∏ô '2025-05-12T17:00:00.000Z'
        incMap[key] = (incMap[key]||0) + Number(r[1]);
      });

      // ‚Äì ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏Å‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô)
      const rawExp = allData.MakroLog.slice(1);
      const expMap  = {};
      rawExp.forEach(r => {
        const key = r[0];
        expMap[key] = (expMap[key]||0) + Number(r[7]);
      });

      // ‚Äì ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (union ‡∏Ç‡∏≠‡∏á incMap + expMap)
      const allDates = Array.from(new Set([
        ...Object.keys(incMap),
        ...Object.keys(expMap)
      ])).sort((a,b) => new Date(a) - new Date(b));

      // ‚Äì ‡∏Ñ‡πà‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ï‡∏¥‡∏° zero ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const incLabels = allDates.map(formatDateLabel);
      const incValues = allDates.map(d => incMap[d]||0);

      // ‚Äì ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°
      const totalInc = incValues.reduce((s,v) => s+v, 0);
      document.getElementById('total-income').textContent = totalInc.toLocaleString();

      // ‚Äì ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô & ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      const incDailySummary   = document.getElementById('income-daily-summary');
      const incMonthlyMap = {};
      allDates.forEach((d,i) => {
        // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
        const li = document.createElement('li');
        li.textContent = `${incLabels[i]}: ${incValues[i].toLocaleString()} ‡∏ø`;
        incDailySummary.appendChild(li);
        // ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        const m = incLabels[i].slice(3); // 'mm/yy'
        incMonthlyMap[m] = (incMonthlyMap[m]||0) + incValues[i];
      });
      const incMonthlySummary = document.getElementById('income-monthly-summary');
      Object.keys(incMonthlyMap).sort().forEach(m => {
        const li = document.createElement('li');
        li.textContent = `${m}: ${incMonthlyMap[m].toLocaleString()} ‡∏ø`;
        incMonthlySummary.appendChild(li);
      });

      // ‚Äì ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
      new Chart(document.getElementById('incomeDailyChart'), {
        type: 'bar',
        data: { labels: incLabels, datasets: [{ label: '‡∏ø', data: incValues }] }
      });

      // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

      // ‚Äì ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
      const expLabels = allDates.map(formatDateLabel);
      const expValues = allDates.map(d => expMap[d]||0);
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°
      const totalExp = expValues.reduce((s,v) => s+v, 0);
      document.getElementById('total-expenses').textContent = totalExp.toLocaleString();

      // ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô & ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      const expDailySummary   = document.getElementById('daily-summary');
      const expMonthlyMap = {};
      allDates.forEach((d,i) => {
        const li = document.createElement('li');
        li.textContent = `${expLabels[i]}: ${expValues[i].toLocaleString()} ‡∏ø`;
        expDailySummary.appendChild(li);
        const m = expLabels[i].slice(3);
        expMonthlyMap[m] = (expMonthlyMap[m]||0) + expValues[i];
      });
      const expMonthlySummary = document.getElementById('monthly-summary');
      Object.keys(expMonthlyMap).sort().forEach(m => {
        const li = document.createElement('li');
        li.textContent = `${m}: ${expMonthlyMap[m].toLocaleString()} ‡∏ø`;
        expMonthlySummary.appendChild(li);
      });

      // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
      new Chart(document.getElementById('dailyChart'), {
        type: 'bar',
        data: { labels: expLabels, datasets: [{ label: '‡∏ø', data: expValues }] }
      });

      // ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏à‡∏≤‡∏Å rawExp)
      const categoryMap = {};
      rawExp.forEach(r => {
        const cat = r[3];
        categoryMap[cat] = (categoryMap[cat]||0) + Number(r[7]);
      });
      const catLabels = Object.keys(categoryMap);
      const catValues = catLabels.map(c => categoryMap[c]);
      new Chart(document.getElementById('categoryChart'), {
        type: 'pie',
        data: { labels: catLabels, datasets: [{ data: catValues }] }
      });

      // Top 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πà‡∏≠‡∏¢
      const freq = {};
      rawExp.forEach(r => {
        const name = r[2];
        freq[name] = (freq[name]||0) + 1;
      });
      const top5 = Object.entries(freq)
        .sort((a,b) => b[1]-a[1])
        .slice(0,5);
      const tbody = document.querySelector('#top-items tbody');
      top5.forEach(([name,count]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${count}</td>`;
        tbody.appendChild(tr);
      });
    }
  </script>

  <!-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å JSONP ‡∏à‡∏≤‡∏Å GAS -->
  <script src="https://script.google.com/macros/s/AKfycbydtdvHtF6-MYNcQ5CFYvwe2_ke6IHrnEgBRMN73eg_aiZmYMrbbOuedQieJbeUamgT/exec?callback=renderDashboard"></script>
</body>
</html>
