<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏• / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <style>
    /* ======================== */
    /* 1. CSS ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    /* ======================== */
    body {
      background-color: #e0f2fe; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
      font-family: 'Noto Sans', sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: #ffffff; /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ======================== */
    /* 2. Layout input ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß */
    /* ======================== */
    .form-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .form-group {
      flex: 1 1 200px;
      min-width: 250px;
    }

    /* ======================== */
    /* 3. ‡∏õ‡∏∏‡πà‡∏° ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å */
    /* ======================== */
    .btn-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }
    #add-item {
      background: #fbbf24;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px;
      cursor: pointer;
      font-size: 16px;
    }
    #submit {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px;
      cursor: pointer;
      font-size: 16px;
      flex: 1;
      margin-left: 16px;
    }

    /* ======================== */
    /* 4. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (item card) */
    /* ======================== */
    .items {
      margin-top: 32px;
    }
    .item {
      background: #ffffff;
      border: 1px solid #ccc;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
    }
    .item h2 {
      font-size: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      color: #111827;
    }
    .item h2::before {
      content: 'üìå';
      margin-right: 12px;
    }
    .item-index {
      font-weight: bold;
      margin-left: 4px;
    }
    .remove {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }

    /* ======================== */
    /* 5. Style label ‡πÅ‡∏•‡∏∞ input */
    /* ======================== */
    label {
      display: flex;
      align-items: center;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #374151;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #fafafa;
      box-sizing: border-box;
    }
    @media (max-width: 600px) {
  .form-row {
    flex-direction: column; /* ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    gap: 12px;
  }
  .form-group {
    flex: 1 1 100%; /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
  }
  input, textarea, select {
    font-size: 13px;
    padding: 6px;
  }
  .container {
    padding: 16px;
  }
  .form-row {
    gap: 8px
  }
  h1 {
    font-size: 20px;
    margin-bottom: 16px;
  }
  #add-item, #submit {
    font-size: 14px;
    padding: 8px;
  }
}
  </style>
  <!-- SweetAlert2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö popup -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ü‡∏≠‡∏£‡πå‡∏° -->
    <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>

    <!-- ‡πÅ‡∏ñ‡∏ß‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠ -> ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô -->
    <div class="form-row">
      <div class="form-group">
        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="date" id="date_bill">
      </div>
      <div class="form-group">
        <label>üè™ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="text" id="supplier" list="supplierlist" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠">
      </div>
    </div>

    <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å -->
    <div class="items" id="items-container"></div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (‡∏ã‡πâ‡∏≤‡∏¢) ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Ç‡∏ß‡∏≤) -->
    <div class="btn-row">
      <button id="add-item">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
      <button id="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
  </div>

  <!-- datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autofill ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ supplier -->
  <datalist id="namelist"></datalist>
  <datalist id="supplierlist">
    <option value="Makro">
    <option value="Tops">
    <option value="Lotus">
    <option value="Lazada">
    <option value="Shopee">
  </datalist>

  <!-- Template ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
  <template id="item-template">
    <div class="item">
      <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç -->
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà <span class="item-index">1</span></h2>

      <!-- ‡πÅ‡∏ñ‡∏ß‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
      <div class="form-row">
        <div class="form-group">
          <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
          <input type="text" class="name" list="namelist" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
        </div>
          <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏° list="grouplist" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö datalist ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á -->
          <div class="form-group">
          <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
          <input type="text" class="group" list="grouplist" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
          </div>
            <!-- datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
            <datalist id="grouplist">
              <option value="‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß">
              <option value="‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏°">
              <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô">
              <option value="‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô/‡πÉ‡∏ä‡πâ‡∏û‡∏£‡∏≤‡∏ß">
              <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß">
              <option value="‡∏¢‡∏≤">
              <option value="‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß/‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô">
              <option value="‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°">
              <option value="‡∏á‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á">
            </datalist>
           </div>
      <!-- ‡πÅ‡∏ñ‡∏ß‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡∏´‡∏ô‡πà‡∏ß‡∏¢, ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ -->
      <div class="form-row">
        <div class="form-group">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
          <input type="number" class="amount" value="1">
        </div>
        <div class="form-group">
          <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
          <input type="text" class="unit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏Å‡∏¥‡πÇ‡∏•">
        </div>
        <div class="form-group">
          <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
          <input type="number" step="0.01" class="price_unit" placeholder="0.00">
        </div>
      </div>

      <!-- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ -->
      <div class="form-group">
        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</label>
        <input type="text" class="total" readonly placeholder="--">
      </div>

      <!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
      <div class="form-group">
        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea class="note" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
      <button class="remove">‡∏•‡∏ö</button>
    </div>
  </template>

  <script>
    // ========================
    // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡∏Ç‡∏≠‡∏á Google Apps Script
    // ========================
    const apiURL = 'https://script.google.com/macros/s/AKfycbzez-fh075oK0A8-JxKz2sozwPLj2uF9jrpPLA_Mq0707SVhi2pp_FIa0NOfYe8EM8aYA/exec';

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    window.savedState = window.savedState || { dataList: [], totalItems: 0, savedCount: 0 };

    /**
     * ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• marketlist ‡∏ú‡πà‡∏≤‡∏ô JSONP ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏Å handleData
     */
    function loadData() {
      const tag = document.createElement('script');
      tag.src = `${apiURL}?sheet=marketlist&callback=handleData`;
      document.body.appendChild(tag);
    }

    /**
     * Callback ‡∏Ç‡∏≠‡∏á marketlist
     * ‡πÄ‡∏ï‡∏¥‡∏° <option> ‡πÉ‡∏ô #namelist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete
     */
    function handleData(data) {
      window.savedState.dataList = data;
      const dl = document.getElementById('namelist');
      dl.innerHTML = '';
      data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.name;
        dl.appendChild(opt);
      });
      updateItemIndices(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    }

    /**
     * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
     */
    function addItemRow() {
      const cont = document.getElementById('items-container');
      const clone = document.getElementById('item-template').content.cloneNode(true);
      // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô
      clone.querySelector('.remove').addEventListener('click', e => {
        e.target.closest('.item').remove();
        updateItemIndices();
      });
      cont.appendChild(clone);
      updateItemIndices();
    }

    /**
     * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å
     */
    function updateItemIndices() {
      document.querySelectorAll('.item').forEach((el, idx) => {
        el.querySelector('.item-index').textContent = idx + 1;
      });
    }

    /**
     * ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
     */
    function resetForm() {
      document.getElementById('date_bill').value = '';
      document.getElementById('supplier').value = '';
      const cont = document.getElementById('items-container');
      cont.innerHTML = '';
      window.savedState.totalItems = 0;
      window.savedState.savedCount = 0;
      addItemRow();
    }

    /**
     * ‡∏ú‡∏π‡∏Å event ‡∏ü‡∏≠‡∏£‡πå‡∏° input ‡πÉ‡∏ô items-container
     * - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° unit, group, price ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total
     * - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total ‡πÉ‡∏´‡∏°‡πà
     */
    document.getElementById('items-container').addEventListener('input', e => {
      const row = e.target.closest('.item');
      if (e.target.classList.contains('name')) {
        const found = window.savedState.dataList.find(x => x.name.trim().toLowerCase() === e.target.value.trim().toLowerCase());
        if (found) {
          row.querySelector('.unit').value = found.unit || '';
          row.querySelector('.group').value = found.group || '';
          row.querySelector('.price_unit').value = found.price_unit || '';
          const qty = parseFloat(row.querySelector('.amount').value) || 0;
          const price = parseFloat(found.price_unit) || 0;
          row.querySelector('.total').value = (qty * price).toFixed(2);
        }
      }
      if (e.target.classList.contains('amount') || e.target.classList.contains('price_unit')) {
        const qty = parseFloat(row.querySelector('.amount').value) || 0;
        const price = parseFloat(row.querySelector('.price_unit').value) || 0;
        row.querySelector('.total').value = (qty * price).toFixed(2);
      }
    });

    /**
     * ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
     */
    document.getElementById('add-item').addEventListener('click', addItemRow);

    /**
     * ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
     * - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö input date ‡πÅ‡∏•‡∏∞ supplier
     * - ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° items ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
     * - ‡πÅ‡∏™‡∏î‡∏á preview ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
     */
    document.getElementById('submit').addEventListener('click', () => {
      const dateBill = document.getElementById('date_bill').value;
      const supplier = document.getElementById('supplier').value;
      if (!dateBill || !supplier) {
        return Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠', 'warning');
      }
      const items = [];
      document.querySelectorAll('.item').forEach(r => {
        const nm = r.querySelector('.name').value;
        const un = r.querySelector('.unit').value;
        const gr = r.querySelector('.group').value;
        const am = r.querySelector('.amount').value;
        const pu = r.querySelector('.price_unit').value;
        const to = r.querySelector('.total').value;
        const note = r.querySelector('.note').value || '';
        if (nm && am) items.push({ nm, un, gr, am, pu, to, note });
      });
      if (items.length === 0) {
        return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 'warning');
      }
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML preview ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
      let receiptHtml = `<div style="text-align:left; font-size:13px;">üßæ <strong>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</strong><br>
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateBill}<br>
      ‡∏£‡πâ‡∏≤‡∏ô: ${supplier}
      <hr>
      `;
      items.forEach(it => {
        receiptHtml += `
          <strong>${it.nm}</strong> (${it.gr})<br>
          ${it.am} ${it.un} x ${it.pu} = ${it.to} ‡∏ö‡∏≤‡∏ó<br>
        `;
      });
      const totalSum = items.reduce((sum, i) => sum + parseFloat(i.to || 0), 0).toFixed(2);
      receiptHtml += `
            <hr>
            <em>‡∏£‡∏ß‡∏° ${totalSum} ‡∏ö‡∏≤‡∏ó</em>
            </div>
      `;

      Swal.fire({
        title: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        html: receiptHtml,
        width: 320,
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        cancelButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'
      }).then(result => {
        if (result.isConfirmed) {
          window.savedState.totalItems = items.length;
          window.savedState.savedCount = 0;
          Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
          // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô JSONP
          items.forEach(it => {
            const qs = `?sheet=datalog&date_bill=${encodeURIComponent(dateBill)}&supplier=${encodeURIComponent(supplier)}&name=${encodeURIComponent(it.nm)}&unit=${encodeURIComponent(it.un)}&group=${encodeURIComponent(it.gr)}&amount=${encodeURIComponent(it.am)}&price_unit=${encodeURIComponent(it.pu)}&total=${encodeURIComponent(it.to)}&note=${encodeURIComponent(it.note)}&callback=handleSubmit`;
            const sc = document.createElement('script');
            sc.src = apiURL + qs;
            document.body.appendChild(sc);
          });
        }
      });
    });

    /**
     * Callback ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à
     * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -> ‡∏õ‡∏¥‡∏î loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á success + reset form
     */
    function handleSubmit(msg) {
      window.savedState.savedCount++;
      if (window.savedState.savedCount >= window.savedState.totalItems) {
        Swal.close();
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success')
          .then(() => {
            resetForm(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
          });
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏£‡∏Å
    loadData();
    addItemRow();
  </script>
</body>
</html>
