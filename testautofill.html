<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏• / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <style>
    /* CSS: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
    body { background-color: #e0f2fe; font-family: 'Noto Sans', sans-serif; margin: 0; padding: 20px; }
    .container { background: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); max-width: 800px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 24px; margin-bottom: 24px; display: flex; align-items: center; color: #111827; }
    h1::before { content: 'üßæ'; margin-right: 8px; font-size: 24px; }
    .form-row { display: flex; gap: 16px; flex-wrap: wrap; }
    .form-row .form-group { flex: 1 1 200px; }
    label { display: flex; align-items: center; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #374151; }
    input, textarea, select { width: 100%; padding: 8px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 4px; background: #fafafa; box-sizing: border-box; }
    .items { margin-top: 32px; }
    .item { background: #ffffff; border: 1px solid #ccc; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 6px; padding: 16px; margin-bottom: 16px; position: relative; }
    .item h2 { line-height: 1.2; font-size: 18px; margin-bottom: 12px; display: flex; align-items: center; color: #111827; }
    .item h2::before { content: 'üìå'; margin-right: 12px; }
    .item-index { display: inline-block; vertical-align: middle; font-weight: bold; margin-left: 4px; }
    .remove { position: absolute; top: 16px; right: 16px; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; }
    #add-item, #submit { margin-top: 16px; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 16px; }
    #add-item { background: #fbbf24; color: white; border: none; }
    #submit { background: #3b82f6; color: white; border: none; width: 100%; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
    <div class="form-row">
      <div class="form-group">
        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="date" id="date_bill">
      <//div>
      <div class="form-group">
        <label>üè™ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="text" id="supplier" list="supplierlist" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠">
      </div>
    </div>
    <div class="items" id="items-container"></div>
    <button id="add-item">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
    <button id="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <datalist id="namelist"></datalist>
  <datalist id="supplierlist">
    <option value="Makro">
    <option value="Tops">
    <option value="Lotus">
    <option value="Lazada">
    <option value="Shopee">
  </datalist>

  <template id="item-template">
    <div class="item">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà¬†<span class="item-index">1</span></h2>
      <div class="form-row">
        <div class="form-group"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label><input type="text" class="name" list="namelist" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"></div>
        <div class="form-group"><label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><input type="text" class="group" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="number" class="amount" value="1"></div>
        <div class="form-group"><label>‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input type="text" class="unit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏Å‡∏¥‡πÇ‡∏•"></div>
        <div class="form-group"><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input type="number" step="0.01" class="price_unit" placeholder="0.00"></div>
      </div>
      <div class="form-group"><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</label><input type="text" class="total" readonly placeholder="--"></div>
      <div class="form-group"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea class="note" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea></div>
      <button class="remove">‡∏•‡∏ö</button>
    </div>
  </template>

  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbzez-fh075oK0A8-JxKz2sozwPLj2uF9jrpPLA_Mq0707SVhi2pp_FIa0NOfYe8EM8aYA/exec';
    window.savedState = window.savedState || { dataList: [], totalItems: 0, savedCount: 0 };

    function loadData() {
      const tag = document.createElement('script');
      tag.src = apiURL + '?sheet=marketlist&callback=handleData';
      document.body.appendChild(tag);
    }

    function handleData(data) {
      window.savedState.dataList = data;
      const dl = document.getElementById('namelist');
      dl.innerHTML = '';
      data.forEach(item => {
        const opt = document.createElement('option'); opt.value = item.name;
        dl.appendChild(opt);
      });
      updateItemIndices();
    }

    function addItemRow() {
      const cont = document.getElementById('items-container');
      const clone = document.getElementById('item-template').content.cloneNode(true);
      clone.querySelector('.remove').addEventListener('click', e => { e.target.closest('.item').remove(); updateItemIndices(); });
      cont.appendChild(clone);
      updateItemIndices();
    }

    function updateItemIndices() {
      document.querySelectorAll('.item').forEach((el, idx) => el.querySelector('.item-index').textContent = idx+1);
    }

    function resetForm() {
      document.getElementById('date_bill').value = '';
      document.getElementById('supplier').value = '';
      const cont = document.getElementById('items-container');
      cont.innerHTML = '';
      window.savedState.totalItems = 0;
      window.savedState.savedCount = 0;
      addItemRow();
    }

    document.getElementById('items-container').addEventListener('input', e => {
      const row = e.target.closest('.item');
      if (e.target.classList.contains('name')) {
        const found = window.savedState.dataList.find(x => x.name.trim().toLowerCase() === e.target.value.trim().toLowerCase());
        if (found) {
          row.querySelector('.unit').value = found.unit || '';
          row.querySelector('.group').value = found.group || '';
          row.querySelector('.price_unit').value = found.price_unit ?? '';
          const qty = parseFloat(row.querySelector('.amount').value) || 0;
          const price = parseFloat(found.price_unit) || 0;
          row.querySelector('.total').value = (qty*price).toFixed(2);
        }
      }
      if (e.target.classList.contains('amount') || e.target.classList.contains('price_unit')) {
        const qty = parseFloat(row.querySelector('.amount').value) || 0;
        const price = parseFloat(row.querySelector('.price_unit').value) || 0;
        row.querySelector('.total').value = (qty*price).toFixed(2);
      }
    });

    document.getElementById('add-item').addEventListener('click', addItemRow);

    document.getElementById('submit').addEventListener('click', () => {
      const dateBill = document.getElementById('date_bill').value;
      const supplier = document.getElementById('supplier').value;
      if (!dateBill || !supplier) {
        return Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠', 'warning');
      }
      const items=[];
      document.querySelectorAll('.item').forEach(r => {
        const nm=r.querySelector('.name').value;
        const un=r.querySelector('.unit').value;
        const gr=r.querySelector('.group').value;
        const am=r.querySelector('.amount').value;
        const pu=r.querySelector('.price_unit').value;
        const to=r.querySelector('.total').value;
        const note=r.querySelector('.note').value||'';
        if (nm && am) items.push({nm,un,gr,am,pu,to,note});
      });
      if (items.length===0) return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','warning');

      let receiptHtml = `<div style="text-align:left;font-size:13px;">üßæ <strong>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</strong><br>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateBill}<br>‡∏£‡πâ‡∏≤‡∏ô: ${supplier}<hr>`;
      items.forEach(it => receiptHtml+=`${it.nm} (${it.gr})<br>${it.am} ${it.un} x ${it.pu} = ${it.to} ‡∏ö‡∏≤‡∏ó<br>`);
      receiptHtml+=`<hr><em>‡∏£‡∏ß‡∏° ${(items.reduce((sum,i)=>sum+parseFloat(i.to||0),0)).toFixed(2)} ‡∏ö‡∏≤‡∏ó</em></div>`;

      Swal.fire({ title:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', html:receiptHtml, width:320, showCancelButton:true, confirmButtonText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'})
        .then(result => {
          if (result.isConfirmed) {
            window.savedState.totalItems = items.length;
            window.savedState.savedCount = 0;
            Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
            items.forEach(it=>{
              const qs = `?sheet=datalog&date_bill=${encodeURIComponent(dateBill)}&supplier=${encodeURIComponent(supplier)}&name=${encodeURIComponent(it.nm)}&unit=${encodeURIComponent(it.un)}&group=${encodeURIComponent(it.gr)}&amount=${encodeURIComponent(it.am)}&price_unit=${encodeURIComponent(it.pu)}&total=${encodeURIComponent(it.to)}&note=${encodeURIComponent(it.note)}&callback=handleSubmit`;
              const sc = document.createElement('script'); sc.src = apiURL + qs; document.body.appendChild(sc);
            });
          }
        });
    });

    function handleSubmit(msg) {
      window.savedState.savedCount++;
      if (window.savedState.savedCount >= window.savedState.totalItems) {
        Swal.close();
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success')
          .then(() => { resetForm(); });
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
    loadData();
    addItemRow();
  </script>
</body>
</html>
