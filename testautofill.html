<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏• / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <style>
    body { background-color: #f5f6f8; font-family: 'Noto Sans', sans-serif; margin: 0; padding: 20px; }
    .container {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      color: #111827;
    }
    h1::before { content: 'üßæ'; margin-right: 8px; font-size: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: flex;
      align-items: center;
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }
    .form-group label.icon-date::before { content: 'üìÖ'; margin-right: 8px; }
    .form-group label.icon-supplier::before { content: 'üè™'; margin-right: 8px; }
    input, textarea {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #fafafa;
      box-sizing: border-box;
    }
    input:focus, textarea:focus {
      border-color: #3b82f6;
      outline: none;
      background: #ffffff;
    }
    .items { margin-top: 32px; }
    .item {
      background: #fafbfc;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
    }
    .item h2 {
      font-size: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      color: #111827;
    }
    .item h2::before { content: 'üìå'; margin-right: 8px; }
    .form-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .form-row .form-group { flex: 1 1 120px; }
    button.remove {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #ef4444;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
      color: #ffffff;
      cursor: pointer;
    }
    #add-item {
      background: #fbbf24;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
    }
    #submit {
      background: #3b82f6;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      padding: 12px;
      font-size: 16px;
      width: 100%;
      margin-top: 24px;
      cursor: pointer;
    }
    .nav {
      margin-top: 32px;
      display: flex;
      gap: 16px;
    }
    .nav a {
      color: #6b7280;
      text-decoration: none;
      font-size: 14px;
    }
    .nav a:hover { text-decoration: underline; }
  </style>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏• / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>

    <div class="form-group">
      <label class="icon-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
      <input type="date" id="date_bill">
    </div>
    <div class="form-group">
      <label class="icon-supplier">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
      <input type="text" id="supplier" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢">
    </div>

    <div class="items" id="items-container">
      <div class="item">
        <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà 1</h2>
        <div class="form-group">
          <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
          <input type="text" class="name" list="namelist" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
        </div>
        <div class="form-group">
          <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
          <input type="text" class="group" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
            <input type="number" class="amount" value="1">
          </div>
          <div class="form-group">
            <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
            <input type="text" class="unit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏Å‡∏¥‡πÇ‡∏•">
          </div>
          <div class="form-group">
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
            <input type="number" step="0.01" class="price_unit" placeholder="0.00">
          </div>
        </div>
        <div class="form-group">
          <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</label>
          <input type="text" class="total" readonly placeholder="--">
        </div>
        <div class="form-group">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <textarea class="note" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
        </div>
        <button class="remove" onclick="removeRow(this)">‡∏•‡∏ö</button>
      </div>
    </div>

    <button id="add-item" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
    <button id="submit" onclick="submitData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>

    <div class="nav">
      <a href="#">‚óÄÔ∏è ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="#">üìä Dashboard</a>
      <a href="#">üìÑ Google Sheet</a>
    </div>
  </div>

  <datalist id="namelist"></datalist>
  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbzez-fh075oK0A8-JxKz2sozwPLj2uF9jrpPLA_Mq0707SVhi2pp_FIa0NOfYe8EM8aYA/exec';
    let dataList = [];
    let totalItems = 0;
    let savedCount = 0;

    function loadData() {
      const s = document.createElement('script');
      s.src = apiURL + '?sheet=marketlist&callback=handleData';
      document.body.appendChild(s);
    }

    function handleData(data) {
      dataList = data;
      const dl = document.getElementById('namelist');
      data.forEach(i => {
        let o = document.createElement('option');
        o.value = i.name;
        dl.appendChild(o);
      });
    }

    function addItemRow() {
      const cont = document.getElementById('items-container');
      const row  = cont.firstElementChild.cloneNode(true);
      row.querySelectorAll('input, textarea').forEach(i => i.value = '');
      cont.appendChild(row);
    }

    function removeRow(btn) {
      const rows = document.querySelectorAll('.item');
      if (rows.length > 1) btn.closest('.item').remove();
    }

    document.getElementById('items-container').addEventListener('input', e => {
      let row = e.target.closest('.item');
      if (e.target.classList.contains('name')) {
        let fn = dataList.find(x => x.name === e.target.value);
        if (fn) {
          row.querySelector('.unit').value = fn.unit;
          row.querySelector('.group').value = fn.group;
        }
      }
      if (e.target.classList.contains('amount') || e.target.classList.contains('price_unit')) {
        let a = parseFloat(row.querySelector('.amount').value) || 0;
        let p = parseFloat(row.querySelector('.price_unit').value) || 0;
        row.querySelector('.total').value = (a * p).toFixed(2);
      }
    });

    function submitData() {
      const dateBill = document.getElementById('date_bill').value;
      const supplier = document.getElementById('supplier').value;
      const items = [];
      document.querySelectorAll('.item').forEach((r,i) => {
        const nm = r.querySelector('.name').value;
        const un = r.querySelector('.unit').value;
        const gr = r.querySelector('.group').value;
        const am = r.querySelector('.amount').value;
        const pu = r.querySelector('.price_unit').value;
        const to = r.querySelector('.total').value;
        const note = r.querySelector('.note').value || '';
        items.push({ nm, un, gr, am, pu, to, note });
      });
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML preview
      let html = `<div style="text-align:left; line-height:1.5;">
                    <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•: ${dateBill}</p>
                    <p>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: ${supplier}</p>
                    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                      <tr>
                        <th style="border:1px solid #ddd; padding:4px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <th style="border:1px solid #ddd; padding:4px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th style="border:1px solid #ddd; padding:4px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        <th style="border:1px solid #ddd; padding:4px;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        <th style="border:1px solid #ddd; padding:4px;">‡∏£‡∏ß‡∏°</th>
                      </tr>`;
      items.forEach(it => {
        html += `<tr><td style="border:1px solid #ddd; padding:4px;">${it.nm}</td>
                 <td style="border:1px solid #ddd; padding:4px;">${it.am}</td>
                 <td style="border:1px solid #ddd; padding:4px;">${it.un}</td>
                 <td style="border:1px solid #ddd; padding:4px;">${it.pu}</td>
                 <td style="border:1px solid #ddd; padding:4px;">${it.to}</td></tr>`;
      });
      html += `</table></div>`;
      // ‡πÅ‡∏™‡∏î‡∏á confirm popup
      Swal.fire({
        title: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        html: html,
        width: 600,
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then(result => {
        if (result.isConfirmed) {
          // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
          totalItems = items.length;
          savedCount = 0;
          Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
          });
          // ‡∏™‡πà‡∏á JSONP ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          items.forEach(it => {
            const qs = `?sheet=datalog&date_bill=${encodeURIComponent(dateBill)}` +
                       `&supplier=${encodeURIComponent(supplier)}` +
                       `&name=${encodeURIComponent(it.nm)}` +
                       `&unit=${encodeURIComponent(it.un)}` +
                       `&group=${encodeURIComponent(it.gr)}` +
                       `&amount=${encodeURIComponent(it.am)}` +
                       `&price_unit=${encodeURIComponent(it.pu)}` +
                       `&total=${encodeURIComponent(it.to)}` +
                       `&note=${encodeURIComponent(it.note)}&callback=handleSubmit`;
            const sc = document.createElement('script');
            sc.src = apiURL + qs;
            document.body.appendChild(sc);
          });
        }
      });
    }

    function handleSubmit(msg) {
      savedCount++;
      if (savedCount >= totalItems) {
        Swal.close();
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      }
    }

    loadData();
  </script>
</body>
</html>

