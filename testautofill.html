<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <!-- ‡∏õ‡∏£‡∏±‡∏ö viewport-fit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Safe Area ‡∏ö‡∏ô iPhone -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏• / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>

  <!-- ========================
       CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏° Responsive + Safe Area)
       ======================== -->
  <style>
    /* ========================
       1. ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Base)
       ======================== */
    body {
      /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Safe Area ‡∏Ç‡∏≠‡∏á iPhone */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      background-color: #e0f2fe;
      font-family: 'Noto Sans', sans-serif;
      margin: 0;
    }
    .container {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 16px auto;
      padding: 16px;
    }
    h1 {
      font-size: 24px;
      margin: 0 0 16px;
      text-align: center;
    }

    /* ========================
       2. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠
       ======================== */
    .form-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .form-group {
      flex: 1 1 160px;
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #374151;
    }
    .form-group input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fafafa;
    }

    /* ========================
       3. Card ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
       ======================== */
    .items {
      margin-top: 8px;
    }
    .item {
      background: #e0f7ff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      position: relative;
    }
    .item h2 {
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: bold;
      color: #111827;
    }

    /* ‡πÅ‡∏ñ‡∏ß‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà */
    .item-grid.header {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    /* ‡πÅ‡∏ñ‡∏ß‡∏´‡∏•‡∏±‡∏Å: Amount, Unit, Price, Total */
    .item-grid.main {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 8px;
    }
    /* ‡πÅ‡∏ñ‡∏ß‡∏£‡∏≠‡∏á: In unit, Sec Unit, Remarks (Remarks ‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå) */
    .item-grid.secondary {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    .item-grid input {
      padding: 6px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
    }
    .remove {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
    }

    /* ========================
       4. ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
       ======================== */
    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    #add-item {
      flex: 0 0 auto;
      background: #fbbf24;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #submit {
      flex: 1 1 auto;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }

    /* ========================
       5. Responsive for iPhone
       ======================== */
    @media (max-width: 480px) {
      .form-row {
        flex-direction: column;
      }
      .item-grid.main {
        grid-template-columns: 1fr 1fr;
      }
      .item-grid.secondary {
        grid-template-columns: 1fr;
      }
      #add-item, #submit {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>

  <!-- SweetAlert2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>

    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠ -->
    <div class="form-row">
      <div class="form-group">
        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="date" id="date_bill" />
      <//div>
      <div class="form-group">
        <label>üè™ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="text" id="supplier" list="supplierlist" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠" />
      <//div>
    </div>

    <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div class="items" id="items-container"></div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á -->
    <div class="btn-row">
      <button id="add-item">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
      <button id="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
  </div>

  <!-- datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete -->
  <datalist id="namelist"></datalist>
  <datalist id="supplierlist">
    <option value="Makro"><option value="Tops"><option value="Lotus">
    <option value="Lazada"><option value="Shopee">
  </datalist>

  <!-- Template ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
  <template id="item-template">
    <div class="item">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà <span class="item-index">1</span></h2>

      <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
      <div class="item-grid header">
        <input type="text" class="name" list="namelist" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" />
        <input type="text" class="group" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" list="grouplist" />
      </div>
      <datalist id="grouplist">
        <option value="‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß"><option value="‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏°"><option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô">
        <option value="‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô/‡πÉ‡∏ä‡πâ‡∏û‡∏£‡∏≤‡∏ß"><option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß"><option value="‡∏¢‡∏≤">
        <option value="‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß/‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô"><option value="‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°"><option value="‡∏á‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á">
      </datalist>

      <!-- Amount | Unit | Price | Total -->
      <div class="item-grid main">
        <input type="number" class="amount" placeholder="Amount" />
        <input type="text"   class="unit"   placeholder="Unit" />
        <input type="number" class="price_unit" step="0.01" placeholder="Price Unit" />
        <input type="text"   class="total" readonly placeholder="Total" />
      </div>

      <!-- In unit | Sec Unit | Remarks -->
      <div class="item-grid secondary">
        <input type="text" class="in_unit" placeholder="In unit" />
        <input type="text" class="sec_unit" placeholder="Sec Unit" />
        <input type="text" class="note" placeholder="Remarks" />
      </div>

      <button class="remove">‡∏•‡∏ö</button>
    </div>
  </template>

  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbzez-fh075oK0A8-JxKz2sozwPLj2uF9jrpPLA_Mq0707SVhi2pp_FIa0NOfYe8EM8aYA/exec';
    window.savedState = window.savedState || { dataList: [], totalItems: 0, savedCount: 0 };

    function loadData() {
      const tag = document.createElement('script');
      tag.src = `${apiURL}?sheet=marketlist&callback=handleData`;
      document.body.appendChild(tag);
    }

    function handleData(data) {
      window.savedState.dataList = data;
      const dl = document.getElementById('namelist'); dl.innerHTML = '';
      data.forEach(item => { const opt = document.createElement('option'); opt.value = item.name; dl.appendChild(opt); });
      updateItemIndices();
    }

    function addItemRow() {
      const cont = document.getElementById('items-container');
      const clone = document.getElementById('item-template').content.cloneNode(true);
      clone.querySelector('.remove').addEventListener('click', e => {
        e.target.closest('.item').remove(); updateItemIndices();
      });
      cont.appendChild(clone); updateItemIndices();
    }

    function updateItemIndices() {
      document.querySelectorAll('.item').forEach((el, idx) => {
        el.querySelector('.item-index').textContent = idx + 1;
      });
    }

    function resetForm() {
      document.getElementById('date_bill').value = ''; document.getElementById('supplier').value = '';
      const cont = document.getElementById('items-container'); cont.innerHTML = '';
      window.savedState.totalItems = 0; window.savedState.savedCount = 0;
      addItemRow();
    }

    document.getElementById('items-container').addEventListener('input', e => {
      const row = e.target.closest('.item');
      if (e.target.classList.contains('amount') || e.target.classList.contains('price_unit')) {
        const qty = parseFloat(row.querySelector('.amount').value) || 0;
        const price = parseFloat(row.querySelector('.price_unit').value) || 0;
        row.querySelector('.total').value = (qty * price).toFixed(2);
      }
    });

    document.getElementById('add-item').addEventListener('click', addItemRow);
    document.getElementById('submit').addEventListener('click', () => {
      const dateBill = document.getElementById('date_bill').value;
      const supplier = document.getElementById('supplier').value;
      if (!dateBill || !supplier) {
        return Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠','warning');
      }
      const items = [];
      document.querySelectorAll('.item').forEach(r => {
        const am = r.querySelector('.amount').value;
        if (!am) return;
        items.push({
          nm: r.querySelector('.name').value,
          un: r.querySelector('.unit').value,
          gr: r.querySelector('.group').value,
          am,
          pu: r.querySelector('.price_unit').value,
          to: r.querySelector('.total').value,
          note: r.querySelector('.note').value
        });
      });
      if (items.length === 0) {
        return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','warning');
      }
      let receiptHtml = `<div style="text-align:left;font-size:13px;">üßæ <strong>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</strong><br>
        ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateBill}<br>‡∏£‡πâ‡∏≤‡∏ô: ${supplier}<hr>`;
      items.forEach(it => {
        receiptHtml += `<strong>${it.nm}</strong> (${it.gr})<br>${it.am} ${it.un} x ${it.pu} = ${it.to} ‡∏ö‡∏≤‡∏ó<br>`;
      });
      const totalSum = items.reduce((sum, i) => sum + parseFloat(i.to||0), 0).toFixed(2);
      receiptHtml += `<hr><em>‡∏£‡∏ß‡∏° ${totalSum} ‡∏ö‡∏≤‡∏ó</em></div>`;

      Swal.fire({
        title: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', html: receiptHtml, width: 320,
        showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'
      }).then(res => {
        if (res.isConfirmed) {
          window.savedState.totalItems = items.length; window.savedState.savedCount = 0;
          Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick:false, didOpen: ()=> Swal.showLoading() });
          items.forEach(it => {
            const qs = `?sheet=datalog&date_bill=${encodeURIComponent(dateBill)}` +
                       `&supplier=${encodeURIComponent(supplier)}` +
                       `&name=${encodeURIComponent(it.nm)}` +
                       `&unit=${encodeURIComponent(it.un)}` +
                       `&group=${encodeURIComponent(it.gr)}` +
                       `&amount=${encodeURIComponent(it.am)}` +
                       `&price_unit=${encodeURIComponent(it.pu)}` +
                       `&total=${encodeURIComponent(it.to)}` +
                       `&note=${encodeURIComponent(it.note)}&callback=handleSubmit`;
            const sc = document.createElement('script'); sc.src = apiURL + qs; document.body.appendChild(sc);
          });
        }
      });
    });

    function handleSubmit(msg) {
      window.savedState.savedCount++;
      if (window.savedState.savedCount >= window.savedState.totalItems) {
        Swal.close(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success').then(()=> resetForm());
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadData();
    addItemRow();
  </script>
</body>
</html>
