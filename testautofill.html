<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>‡∏ü‡∏≠‡∏£‡πå‡∏° Auto Fill ‡∏î‡πâ‡∏ß‡∏¢ JSONP</title>
  <style>
    input, button { margin: 6px; padding: 8px; width: 240px; }
  </style>
</head>
<body>
  <h2>üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>

  <input type="text" id="name" list="namelist" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
  <datalist id="namelist"></datalist><br>

  <input type="text" id="unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" readonly><br>
  <input type="text" id="group" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" readonly><br>

  <button onclick="submitData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

  <div id="preview"></div>

  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbzez-fh075oK0A8-JxKz2sozwPLj2uF9jrpPLA_Mq0707SVhi2pp_FIa0NOfYe8EM8aYA/exec';
    let dataList = [];

    // üì• ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô JSONP
    function loadData() {
      const script = document.createElement('script');
      script.src = apiURL + '?sheet=marketlist&callback=handleData';
      document.body.appendChild(script);
    }

    function handleData(data) {
      dataList = data;
      const datalist = document.getElementById('namelist');
      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        datalist.appendChild(option);
      });
    }

    // üîÑ ‡πÄ‡∏ï‡∏¥‡∏° unit/group ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠
    document.getElementById('name').addEventListener('input', function () {
      const name = this.value.trim();
      const found = dataList.find(d => d.name === name);
      if (found) {
        document.getElementById('unit').value = found.unit || '';
        document.getElementById('group').value = found.group || '';
      }
    });

    // üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö JSONP
    function submitData() {
      const name = document.getElementById('name').value;
      const unit = document.getElementById('unit').value;
      const group = document.getElementById('group').value;

      document.getElementById('preview').innerHTML = `
        <b>üì¶ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á:</b><br>
        ‡∏ä‡∏∑‡πà‡∏≠: ${name}<br>‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${unit}<br>‡∏´‡∏°‡∏ß‡∏î: ${group}<br>
      `;

      const script = document.createElement('script');
      const qs = `?sheet=datalog&name=${encodeURIComponent(name)}&unit=${encodeURIComponent(unit)}&group=${encodeURIComponent(group)}&callback=handleSubmit`;
      script.src = apiURL + qs;
      document.body.appendChild(script);
    }

    function handleSubmit(msg) {
      alert('üì¨ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ' + msg);
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    loadData();
  </script>
</body>
</html>
