<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <!-- รองรับ Safe Area บน iPhone -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>บันทึกบิล / รายจ่าย</title>

<style>
  /* ============================
   1. พื้นฐาน & Safe Area
   ============================ */
  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body {
    background-color: #5fa0ff;
    font-family: 'Noto Sans', sans-serif;
    /* รองรับ Safe Area บน iPhone */
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    -webkit-font-smoothing: antialiased; /* ทำให้ font คมชัดขึ้นบน iOS */
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
  }

  /* ============================
   2. Container & Header
   ============================ */
  .container {
    background: #ffffff;
    border: 2px solid #c2e7ff; /* ลดขนาดขอบเล็กน้อย */
    border-radius: 20px; /* ลดความโค้งเล็กน้อย */
    width: 100%; /* ให้ container เต็มความกว้างของ viewport */
    max-width: 420px; /* กำหนด max-width สำหรับจอที่ใหญ่กว่ามือถือ */
    margin: 0 auto; /* จัดกึ่งกลางเมื่อ max-width ทำงาน */
    padding: 16px;
    min-height: 100vh; /* ให้ container สูงเต็มหน้าจอ */
    display: flex; /* เพิ่ม flexbox เพื่อจัดเรียงเนื้อหาภายใน */
    flex-direction: column; /* จัดเรียงเนื้อหาแนวตั้ง */
  }
  h1 {
    font-size: 22px; /* เพิ่มขนาด font เล็กน้อย */
    text-align: center;
    margin-bottom: 16px; /* เพิ่มระยะห่างด้านล่าง */
    padding-bottom: 10px; /* เพิ่มระยะห่าง padding */
    border-bottom: 3px solid #c2e7ff; /* ลดความหนาเส้นขอบ */
    color: #111827; /* เพิ่มสีตัวอักษร */
  }

  /* ============================
   3. Form Elements & Input Fields
   ============================ */

  /* ใช้กับ form-row ที่ต้องการให้ input อยู่บรรทัดเดียวกัน */
  .form-row {
    display: flex;
    gap: 12px; /* เพิ่ม gap ระหว่าง elements */
    margin-bottom: 12px; /* เพิ่มระยะห่างด้านล่าง */
  }

  .form-group {
    flex: 1 1 auto; /* ให้ form group ขยายตามพื้นที่ที่มี */
    display: flex;
    flex-direction: column; /* จัดเรียง label และ input แนวตั้ง */
  }

  .form-group label { /* เพิ่ม label styling (ถ้ามี) */
    font-size: 14px;
    margin-bottom: 4px;
    color: #374151;
  }

  /* Input ทั่วไป และใน item-grid */
  input[type="text"],
  input[type="number"],
  input[type="date"],
  select, /* เพิ่ม select styling */
  .item-grid input { /* รวม .item-grid input เข้ามาด้วย */
    width: 100%; /* ทำให้ input เต็มความกว้างของ parent */
    padding: 10px 12px; /* ปรับ padding ให้เหมาะสม */
    font-size: 16px; /* ปรับขนาด font */
    border: 1px solid #d1d5db; /* ปรับสีขอบ input */
    border-radius: 12px; /* ปรับความโค้ง */
    background-color: #f9fafb; /* เปลี่ยนสีพื้นหลัง input เล็กน้อย */
    height: 44px; /* กำหนดความสูงมาตรฐาน */
    color: #111827;
  }

  input[type="text"]:focus,
  input[type="number"]:focus,
  input[type="date"]:focus,
  select:focus,
  .item-grid input:focus { /* เพิ่ม focus state */
    outline: none;
    border-color: #5fa0ff;
    box-shadow: 0 0 0 2px rgba(95, 160, 255, 0.3);
  }


  /* ============================
   4. Card รายการสินค้า (Item Card)
   ============================ */
  .items {
    margin-top: 16px; /* เพิ่มระยะห่างด้านบน */
    flex-grow: 1; /* ให้ส่วนรายการสินค้าขยายเต็มพื้นที่ที่เหลือ */
  }
  .item {
    background: #f0f9ff; /* ปรับสีพื้นหลัง card เล็กน้อย */
    border: 1px solid #c2e7ff; /* เพิ่มขอบบางๆ */
    border-radius: 16px; /* ลดความโค้งเล็กน้อย */
    padding: 16px; /* เพิ่ม padding */
    margin-bottom: 20px; /* เพิ่มระยะห่างระหว่าง card */
    box-shadow: 0 2px 8px rgba(0,0,0,0.08); /* ปรับเงา */
    position: relative;
  }
  .item h2 { /* ใช้สำหรับชื่อรายการ หรือ section header ใน card */
    font-size: 18px;
    font-weight: 600; /* ปรับความหนา */
    margin-bottom: 12px;
    color: #0c4a6e; /* ปรับสี */
  }

  /* Grid Layouts ภายใน Card */
  .item-grid { /* Base style for all grids in item */
    display: grid;
    gap: 10px; /* ปรับ gap ให้สอดคล้องกัน */
    margin-bottom: 10px;
  }

  .item-grid.header {
    grid-template-columns: 1fr 1fr; /* ปรับเป็น 2 คอลัมน์เท่ากันสำหรับ mobile first */
  }

  .item-grid.main {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Responsive columns */
  }

  .item-grid.secondary {
    grid-template-columns: 1fr; /* เริ่มจาก 1 คอลัมน์ */
  }

  .remove {
    position: absolute;
    top: 16px; /* ปรับตำแหน่ง */
    right: 16px; /* ปรับตำแหน่ง */
    background: #ef4444;
    color: #fff;
    border: none;
    border-radius: 50%; /* ทำให้เป็นวงกลม */
    width: 32px; /* กำหนดขนาด */
    height: 32px; /* กำหนดขนาด */
    font-size: 16px; /* ปรับขนาดไอคอน (ถ้าใช้ font icon) */
    display: flex; /* จัด icon ให้อยู่กลางปุ่ม */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .remove:hover {
    background: #dc2626;
  }

  /* ============================
   5. ปุ่มด้านล่าง (Action Buttons)
   ============================ */
  .btn-row {
    display: flex;
    gap: 12px;
    margin-top: 24px; /* เพิ่มระยะห่างด้านบน */
    padding-bottom: env(safe-area-inset-bottom); /* เพิ่ม padding ด้านล่างสำหรับ safe area */
  }

  #add-item,
  #submit {
    flex: 1 1 auto; /* ให้ปุ่มขยายเท่ากัน */
    border: none;
    border-radius: 14px; /* ปรับความโค้ง */
    padding: 12px 16px; /* ปรับ padding */
    font-size: 16px;
    font-weight: 500; /* ปรับความหนา */
    cursor: pointer;
    text-align: center;
    height: 48px; /* กำหนดความสูง */
  }

  #add-item {
    background: #ffc107; /* สีเหลืองที่สดใสขึ้น */
    color: #1f2937;
  }
  #add-item:hover {
    background: #ffca2c;
  }

  #submit {
    background: #3b82f6; /* สีฟ้าที่เข้มขึ้น */
    color: #ffffff;
  }
  #submit:hover {
    background: #2563eb;
  }

  /* ============================
   6. Responsive Adjustments (ถ้าจำเป็นต้องปรับเพิ่มเติมสำหรับจอที่ใหญ่ขึ้น)
   ============================ */
  @media (min-width: 640px) { /* สำหรับ Tablet หรือจอที่กว้างขึ้น */
    .container {
      padding: 24px;
      border-radius: 24px;
    }

    h1 {
      font-size: 24px;
    }

    .form-row {
      /* อาจจะไม่ต้องเปลี่ยนถ้า flex ทำงานได้ดีอยู่แล้ว */
    }

    .item-grid.header {
      /* อาจจะยังคง 1fr 1fr หรือปรับตามความเหมาะสม */
    }

    .item-grid.main {
      grid-template-columns: repeat(4, 1fr); /* กลับไปเป็น 4 คอลัมน์สำหรับจอใหญ่ */
    }

    .item-grid.secondary {
      grid-template-columns: 1fr 1fr 2fr; /* กลับไปเป็น layout เดิมสำหรับจอใหญ่ */
    }

    #add-item {
      flex: 0 0 auto; /* ให้ปุ่ม "เพิ่มรายการ" มีขนาดตามเนื้อหา */
      padding: 12px 24px;
    }

    #submit {
      flex: 1 1 auto; /* ให้ปุ่ม "บันทึก" ขยายเต็มพื้นที่ที่เหลือ */
    }

    .btn-row {
      flex-direction: row; /* ทำให้ปุ่มเรียงแนวนอนบนจอใหญ่ */
    }
  }

  /* ส่วน CSS ที่คุณเคยใส่ไว้สำหรับปรับความกระชับ อาจจะไม่จำเป็นแล้ว
     หรือสามารถนำบางส่วนมาปรับใช้กับ @media query ด้านบนได้
     ถ้าต้องการ layout ที่แตกต่างกันระหว่างจอเล็กและจอใหญ่มากๆ
  */

</style>


  <!-- SweetAlert2 สำหรับ popup ยืนยัน -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <h1>บันทึกบิล/รายจ่าย</h1>

    <!-- วันที่ + แหล่งที่ซื้อ -->
    <div class="form-row">
      <div class="form-group">
        <label>📅 วันที่ซื้อ</label>
        <input type="date" id="date_bill" />
      </div>
      <div class="form-group">
        <label>🏪 แหล่งที่ซื้อ</label>
        <input type="text" id="supplier" list="supplierlist" placeholder="เลือกแหล่งที่ซื้อ" />
      </div>
    </div>

    <!-- พื้นที่รายการสินค้า -->
    <div class="items" id="items-container"></div>

    <!-- ปุ่มด้านล่าง -->
    <div class="btn-row">
      <button id="add-item">+ เพิ่มรายการใหม่</button>
      <button id="submit">บันทึกข้อมูลทั้งหมด</button>
    </div>
  </div>

  <!-- datalist สำหรับ autocomplete -->
  <datalist id="namelist"></datalist>
  <datalist id="supplierlist">
    <option value="Makro"><option value="Tops"><option value="Lotus">
    <option value="Lazada"><option value="Shopee">
  </datalist>

  <!-- Template รายการสินค้า -->
  <template id="item-template">
    <div class="item">
      <h2>รายการที่ <span class="item-index">1</span></h2>

      <!-- ชื่อสินค้า + หมวดหมู่ -->
      <div class="item-grid header">
        <input type="text" class="name" list="namelist" placeholder="ชื่อสินค้า" />
        <input type="text" class="group" list="grouplist" placeholder="หมวดหมู่สินค้า" />
      </div>
      <datalist id="grouplist">
        <option value="กับข้าว"><option value="กินข้าว กินขนม"><option value="ของใช้ในบ้าน">
        <option value="ของเล่น/ใช้พราว"><option value="ของใช้ส่วนตัว"><option value="ยา">
        <option value="เที่ยว/พักผ่อน"><option value="งานซ่อม"><option value="งานสร้าง">
      </datalist>

      <!-- Amount | Unit | Price Unit | Total -->
      <div class="item-grid main">
        <input type="number" class="amount" placeholder="Amount" />
        <input type="text"   class="unit"   placeholder="Unit" />
        <input type="number" class="price_unit" step="0.01" placeholder="Price Unit" />
        <input type="text"   class="total" readonly placeholder="Total" />
      </div>

      <!-- In unit | Sec Unit | Remarks -->
      <div class="item-grid secondary">
        <input type="text" class="in_unit" placeholder="In unit" />
        <input type="text" class="sec_unit" placeholder="Sec Unit" />
        <input type="text" class="note" placeholder="Remarks" />
      </div>

      <button class="remove">ลบ</button>
    </div>
  </template>

  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbzez-fh075oK0A8-JxKz2sozwPLj2uF9jrpPLA_Mq0707SVhi2pp_FIa0NOfYe8EM8aYA/exec';
    window.savedState = window.savedState || { dataList: [], totalItems: 0, savedCount: 0 };

    function loadData() {
      const tag = document.createElement('script');
      tag.src = `${apiURL}?sheet=marketlist&callback=handleData`;
      document.body.appendChild(tag);
    }

    function handleData(data) {
      window.savedState.dataList = data;
      const dl = document.getElementById('namelist'); dl.innerHTML = '';
      data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.name;
        dl.appendChild(opt);
      });
      updateItemIndices();
    }

    function addItemRow() {
      const cont = document.getElementById('items-container');
      const clone = document.getElementById('item-template').content.cloneNode(true);
      clone.querySelector('.remove').addEventListener('click', e => {
        e.target.closest('.item').remove();
        updateItemIndices();
      });
      cont.appendChild(clone);
      updateItemIndices();
    }

    function updateItemIndices() {
      document.querySelectorAll('.item').forEach((el, idx) => {
        el.querySelector('.item-index').textContent = idx + 1;
      });
    }

    function resetForm() {
      document.getElementById('date_bill').value = '';
      document.getElementById('supplier').value = '';
      const cont = document.getElementById('items-container');
      cont.innerHTML = '';
      window.savedState.totalItems = 0;
      window.savedState.savedCount = 0;
      addItemRow();
    }

    document.getElementById('items-container').addEventListener('input', e => {
      const row = e.target.closest('.item');
      if (e.target.classList.contains('amount') || e.target.classList.contains('price_unit')) {
        const qty = parseFloat(row.querySelector('.amount').value) || 0;
        const price = parseFloat(row.querySelector('.price_unit').value) || 0;
        row.querySelector('.total').value = (qty * price).toFixed(2);
      }
    });

    document.getElementById('add-item').addEventListener('click', addItemRow);
    document.getElementById('submit').addEventListener('click', () => {
      const dateBill = document.getElementById('date_bill').value;
      const supplier = document.getElementById('supplier').value;
      if (!dateBill || !supplier) {
        return Swal.fire('กรอกข้อมูลไม่ครบ','กรุณาเลือกวันที่และแหล่งที่ซื้อ','warning');
      }
      const items = [];
      document.querySelectorAll('.item').forEach(r => {
        const am = r.querySelector('.amount').value;
        if (!am) return;
        items.push({
          nm: r.querySelector('.name').value,
          un: r.querySelector('.unit').value,
          gr: r.querySelector('.group').value,
          am,
          pu: r.querySelector('.price_unit').value,
          to: r.querySelector('.total').value,
          note: r.querySelector('.note').value
        });
      });
      if (items.length === 0) {
        return Swal.fire('ไม่มีรายการ','ต้องกรอกอย่างน้อยหนึ่งรายการ','warning');
      }
      let receiptHtml = `<div style="text-align:left;font-size:13px;">🧾 <strong>ใบเสร็จ</strong><br>
        วันที่: ${dateBill}<br>ร้าน: ${supplier}<hr>`;
      items.forEach(it => {
        receiptHtml += `<strong>${it.nm}</strong> (${it.gr})<br>${it.am} ${it.un} x ${it.pu} = ${it.to} บาท<br>`;
      });
      const totalSum = items.reduce((sum, i) => sum + parseFloat(i.to||0), 0).toFixed(2);
      receiptHtml += `<hr><em>รวม ${totalSum} บาท</em></div>`;

      Swal.fire({
        title: 'ตรวจสอบข้อมูล',
        html: receiptHtml,
        width: 320,
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'แก้ไข'
      }).then(res => {
        if (res.isConfirmed) {
          window.savedState.totalItems = items.length;
          window.savedState.savedCount = 0;
          Swal.fire({ title:'กำลังบันทึก...', allowOutsideClick:false, didOpen: ()=> Swal.showLoading() });
          items.forEach(it => {
            const qs = `?sheet=datalog&date_bill=${encodeURIComponent(dateBill)}` +
                       `&supplier=${encodeURIComponent(supplier)}` +
                       `&name=${encodeURIComponent(it.nm)}` +
                       `&unit=${encodeURIComponent(it.un)}` +
                       `&group=${encodeURIComponent(it.gr)}` +
                       `&amount=${encodeURIComponent(it.am)}` +
                       `&price_unit=${encodeURIComponent(it.pu)}` +
                       `&total=${encodeURIComponent(it.to)}` +
                       `&note=${encodeURIComponent(it.note)}&callback=handleSubmit`;
            const sc = document.createElement('script'); sc.src = apiURL + qs; document.body.appendChild(sc);
          });
        }
      });
    });

    function handleSubmit(msg) {
      window.savedState.savedCount++;
      if (window.savedState.savedCount >= window.savedState.totalItems) {
        Swal.close();
        Swal.fire('สำเร็จ','บันทึกข้อมูลเรียบร้อย','success').then(()=> resetForm());
      }
    }

    // เริ่มต้นโหลดและเพิ่มแถวแรก
    loadData();
    addItemRow();
  </script>
</body>
</html>
