<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 0 10px; }
    h2 { text-align: center; }
    .form-row, .item-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .form-row input, .item-row input { flex: 1 1 150px; padding: 6px; }
    .item-row { align-items: center; }
    .item-row button.remove { background: #e74c3c; color: #fff; border: none; padding: 4px 8px; cursor: pointer; }
    #add-item { margin: 10px 0; padding: 6px 12px; }
    #submit { padding: 8px 16px; font-size: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h2>üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>

  <!-- ‡∏´‡∏±‡∏ß‡∏ü‡∏≠‡∏£‡πå‡∏° -->
  <div class="form-row">
    <input type="date" id="date_bill" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•">
    <input type="text" id="supplier" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (Supplier)">
  </div>

  <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
  <div id="items-container">
    <div class="item-row">
      <input type="text" class="name" list="namelist" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
      <input type="text" class="unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢">
      <input type="text" class="group" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">
      <input type="number" class="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
      <input type="number" step="0.01" class="price_unit" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢">
      <input type="number" class="total" placeholder="‡∏£‡∏ß‡∏°" readonly>
      <button class="remove" onclick="removeRow(this)">‚úñ</button>
    </div>
  </div>
  <button id="add-item" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

  <button id="submit" onclick="submitData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

  <div id="preview"></div>

  <datalist id="namelist"></datalist>

  <script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbzez-fh075oK0A8-JxKz2sozwPLj2uF9jrpPLA_Mq0707SVhi2pp_FIa0NOfYe8EM8aYA/exec';
    let dataList = [];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• marketlist ‡∏î‡πâ‡∏ß‡∏¢ JSONP
    function loadData() {
      const script = document.createElement('script');
      script.src = apiURL + '?sheet=marketlist&callback=handleData';
      document.body.appendChild(script);
    }

    function handleData(data) {
      dataList = data;
      const datalistEl = document.getElementById('namelist');
      data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.name;
        datalistEl.appendChild(opt);
      });
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° row ‡πÉ‡∏´‡∏°‡πà
    function addItemRow() {
      const container = document.getElementById('items-container');
      const row = container.firstElementChild.cloneNode(true);
      row.querySelectorAll('input').forEach(inp => inp.value = '');
      container.appendChild(row);
    }

    // ‡∏•‡∏ö row
    function removeRow(btn) {
      const rows = document.querySelectorAll('.item-row');
      if (rows.length > 1) btn.closest('.item-row').remove();
    }

    // ‡πÄ‡∏ï‡∏¥‡∏° unit/group ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total
    document.getElementById('items-container').addEventListener('input', e => {
      const row = e.target.closest('.item-row');
      if (e.target.classList.contains('name')) {
        const name = e.target.value.trim();
        const found = dataList.find(d => d.name === name);
        if (found) {
          row.querySelector('.unit').value = found.unit;
          row.querySelector('.group').value = found.group;
        }
      }
      if (e.target.classList.contains('amount') || e.target.classList.contains('price_unit')) {
        const amount = parseFloat(row.querySelector('.amount').value) || 0;
        const price = parseFloat(row.querySelector('.price_unit').value) || 0;
        row.querySelector('.total').value = (amount * price).toFixed(2);
      }
    });

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å row ‡πÅ‡∏ö‡∏ö JSONP
    function submitData() {
      const dateBill = document.getElementById('date_bill').value;
      const supplier = document.getElementById('supplier').value;
      const items = [];

      document.querySelectorAll('.item-row').forEach(row => {
        const name = row.querySelector('.name').value;
        const unit = row.querySelector('.unit').value;
        const group = row.querySelector('.group').value;
        const amount = row.querySelector('.amount').value;
        const price_unit = row.querySelector('.price_unit').value;
        const total = row.querySelector('.total').value;
        items.push({ name, unit, group, amount, price_unit, total });
      });

      // ‡πÅ‡∏™‡∏î‡∏á Preview
      let html = `<h3>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á</h3>`;
      html += `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•: ${dateBill}<br>Supplier: ${supplier}<br><br>`;
      html += `<table><tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏£‡∏ß‡∏°</th></tr>`;
      items.forEach(it => {
        html += `<tr><td>${it.name}</td><td>${it.unit}</td><td>${it.group}</td><td>${it.amount}</td><td>${it.price_unit}</td><td>${it.total}</td></tr>`;
      });
      html += `</table>`;
      document.getElementById('preview').innerHTML = html;

      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      items.forEach(it => {
        const qs = `?sheet=datalog&date_bill=${encodeURIComponent(dateBill)}&supplier=${encodeURIComponent(supplier)}` +
                   `&name=${encodeURIComponent(it.name)}&unit=${encodeURIComponent(it.unit)}` +
                   `&group=${encodeURIComponent(it.group)}&amount=${encodeURIComponent(it.amount)}` +
                   `&price_unit=${encodeURIComponent(it.price_unit)}&total=${encodeURIComponent(it.total)}` +
                   `&callback=handleSubmit`;
        const sc = document.createElement('script');
        sc.src = apiURL + qs;
        document.body.appendChild(sc);
      });
    }

    function handleSubmit(msg) {
      console.log('Result:', msg);
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• marketlist
    loadData();
  </script>
</body>
</html>
